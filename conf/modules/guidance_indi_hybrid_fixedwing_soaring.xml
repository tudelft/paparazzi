<!DOCTYPE module SYSTEM "module.dtd">

<module name="guidance_indi_hybrid_fixedwing_soaring" dir="guidance" task="control">
  <doc>
    <description>
      Guidance controller for fixed-wing soaring
    </description>
  </doc>
  <settings>
    <dl_settings>
      <dl_settings NAME="guidance_indi_hybrid_nld">
        <dl_settings name="controller">
            <dl_setting var="soaring_ctrl_switch" min="0" step="1" max="1" values="OFF|ON" shortname="switching_ctrl"/>
          <dl_setting var="soaring_reduced_ctrl_type" min="0" step="1" max="1" values="OFF|ON" shortname="hor_or_alt"/>
<!--          <dl_setting var="guidance_indi_soaring_use_spline_clcd" min="0" max="1" step="1" values="OFF|ON" shortname="USE_SPLINE"/>-->

<!--          <dl_setting var="guidance_soaring_max_throttle" min="0" step="100" max="9600" shortname="max_throttle"/>-->

          <dl_setting var="guidance_indi_soaring_use_aoa" min="0" max="1" step="1" values="OFF|ON" shortname="USE_AOA"/>
          <dl_setting var="guidance_indi_soaring_use_drag" min="0" max="1" step="1" values="OFF|ON" shortname="USE_DRAG"/>
            <dl_setting var="soaring_critical_aoa" min="0.0" max="0.3" step="0.005" shortname="crit_aoa"/>
          <dl_setting var="guidance_indi_soaring_min_aoa" min="-0.6" max="0.0" step="0.005" shortname="MIN_AOA"/>
          <dl_setting var="guidance_indi_soaring_max_aoa" min="0.0" max="0.6" step="0.005" shortname="MAX_AOA"/>

            <dl_setting var="use_aoa_pitch_limit" min="0" max="1" step="1" values="OFF|ON" shortname="aoa_pitch_limit"/>
            <dl_setting var="use_aoa_pitch_pref" min="0" max="1" step="1" values="OFF|ON" shortname="pitch_pref_on"/>

          <dl_setting var="pitch_eff_scale" min="0.0" max="2.0" step="0.01" shortname="pitch_eff_scale" />

          <dl_setting var="max_acc_sp" min="0.1" step="0.1" max="10" shortname="max_acc_sp_down"/>
          <dl_setting var="min_acc_sp" min="-10" step="0.1" max="-0.1" shortname="min_acc_sp_up"/>

          <dl_setting var="spline_aoa_scale" min="0" step="0.01" max="2" shortname="spl_aoa_scale"/>
          <dl_setting var="spline_aoa_offset" min="-1" step="0.01" max="-1" shortname="spl_aoa_offset"/>
          <dl_setting var="spline_cl_offset" min="-1" step="0.01" max="-1" shortname="spl_cl_offset"/>
          <dl_setting var="spline_cl_scale" min="0" step="0.01" max="2" shortname="spl_cl_scale"/>
          <dl_setting var="spline_cd_scale" min="0" step="0.01" max="2" shortname="spl_cd_scale"/>

          <!--        <dl_setting var="soaring_spd_sp.x" min="-1.0" step="0.001" max="1.0" shortname="speed_sp_x"/>-->
          <!--        <dl_setting var="soaring_spd_sp.y" min="-1.0" step="0.001" max="1.0" shortname="speed_sp_y"/>-->
          <!--        <dl_setting var="soaring_spd_sp.z" min="-1.0" step="0.001" max="1.0" shortname="speed_sp_z"/>-->

<!--          <dl_setting var="gd_gamma_sq" min="0" step="1" max="10000" shortname="gamma_sq"/>-->
          <dl_setting var="Wv_gih[0]" min="0" step="0.1" max="100" shortname="weight_x"/>
          <dl_setting var="Wv_gih[1]" min="0" step="0.1" max="100" shortname="weight_y"/>
          <dl_setting var="Wv_gih[2]" min="0" step="0.1" max="100" shortname="weight_z"/>
          <dl_setting var="Wu_gih[0]" min="0" step="0.1" max="100" shortname="weight_roll"/>
          <dl_setting var="Wu_gih[1]" min="0" step="0.1" max="100" shortname="weight_pitch"/>
          <dl_setting var="Wu_gih[2]" min="0" step="0.1" max="100" shortname="weight_throttle"/>

<!--          <dl_setting var="weight_logistic_fn_factor" min="0" step="0.1" max="10" shortname="Wv_factor"/>-->
<!--          <dl_setting var="use_variable_weights" min="0" step="1" max="1" values="OFF|ON" shortname="variable_weight"/>-->
          <!--          <dl_setting var="gd_gamma_sq" min="0" step="1" max="10000" shortname="gamma_sq"/>-->
        </dl_settings>
        <!--        <dl_settings name="flags">-->
        <!--          -->
        <!--        </dl_settings>-->
        <dl_settings name="soaring">
          <dl_setting var="soaring_mode_running" min="0" step="1" max="1" values="OFF|ON" shortname="Soaring_mode"/>
          <dl_setting var="speed_sp_from_position" min="0" step="1" max="1" values="OFF|ON" shortname="sp_position"/>
          <dl_setting var="y_position_ctrl" min="0" step="1" max="1" values="OFF|ON" shortname="y_pos_ctrl"/>
          <dl_setting var="soaring_explore_positions" min="0" step="1" max="1" values="OFF|ON" shortname="moving_wp"/>

          <dl_setting var="use_fixed_heading_wp" min="0" step="1" max="1" values="OFF|ON" shortname="heading_towards_wp"/>
          <dl_setting var="soaring_heading_gain" min="0.0" step="0.0001" max="1.0" shortname="heading_gain"/>

          <dl_setting var="soaring_min_alt" min="0" step="0.1" max="50" shortname="min_alt"/>

          <dl_setting var="soaring_move_wp_wait_sec" min="0" step="1" max="100" shortname="wp_arr_timeout"/>

          <dl_setting var="stay_wp_duration" min="0" step="0.5" max="20" shortname="wp_arr_count"/>
          <dl_setting var="arrival_check_dist_3d" min="0" step="0.1" max="10" shortname="wp_arrival_dist"/>

          <dl_setting var="move_wp_body_is_ned" min="0" step="1" max="1" shortname="body_is_ned" />
          <dl_setting var="reset_stdby_after_timeout" min="0" step="1" max="1" shortname="reset_stby_after_timeout"/>
          <dl_setting var="reset_unreachable_wp" min="0" step="1" max="1" shortname="reset_unreachable_wp"/>
          <!--          <dl_setting var="heading_target.x" min="1.0" step="0.5" max="50" shortname="heading_target_x"/>-->
          <!--          <dl_setting var="heading_target.y" min="-10.0" step="0.5" max="1.0" shortname="heading_target_y"/>-->
        </dl_settings>
        <dl_settings name="costs">
          <dl_setting var="soaring_move_wp_cost_threshold" min="1" step="0.5" max="500" shortname="cost_threshold"/>

          <dl_setting var="gd_k_thr" min="0" step="0.001" max="10" shortname="wp_throttle_weight"/>
          <dl_setting var="gd_k_spd_x" min="0" step="0.1" max="100" shortname="wp_spd_x_weight"/>
          <dl_setting var="gd_k_spd_z" min="0" step="0.1" max="100" shortname="wp_spd_z_weight"/>
          <dl_setting var="gd_k_pitch" min="0" step="0.1" max="100" shortname="wp_pitch_weight"/>
        </dl_settings>
        <dl_settings name="step_sizes">
          <dl_setting var="soaring_max_exploration_steps" min="1" step="1" max="1000" shortname="max_explore_steps"/>

          <dl_setting var="soaring_use_fixed_step_size" min="0" step="1" max="1" values="OFF|ON" shortname="use_fixed_step_size"/>
          <dl_setting var="soaring_fixed_step_size" min="0" step="0.05" max="10" shortname="fixed_step_size"/>

          <dl_setting var="soaring_step_size_big" min="0" step="0.05" max="10" shortname="step_size_big"/>
          <dl_setting var="soaring_step_size_mid" min="0" step="0.05" max="5" shortname="step_size_mid"/>
          <dl_setting var="soaring_step_size_small" min="0" step="0.01" max="3" shortname="step_size_small"/>
          <dl_setting var="soaring_step_size_fine" min="0" step="0.01" max="1" shortname="step_size_fine"/>

          <dl_setting var="soaring_step_k_big" min="0" step="0.1" max="1000" shortname="big_step_cost_multiplier"/>
          <dl_setting var="soaring_step_k_mid" min="0" step="0.1" max="1000" shortname="mid_step_cost_multiplier"/>
          <dl_setting var="soaring_step_k_small" min="0" step="0.1" max="1000" shortname="small_step_cost_multiplier"/>
        </dl_settings>
        <dl_settings name="manual_search">
          <dl_setting var="soaring_manual_search" min="0" max="1" step="1" values="OFF|ON" shortname="manual_search"/>
          <dl_setting var="soaring_wp_move_forward" min="-10" step="0.01" max="10" shortname="wp_move_forward"/>
          <dl_setting var="soaring_wp_move_up" min="-10" step="0.01" max="10" shortname="wp_move_up"/>
          <dl_setting var="soaring_wp_move_right" min="-10" step="0.01" max="10" shortname="wp_move_right"/>
          <dl_setting var="reset_stdby_timeout" min="0" step="1" max="10" shortname="stdby_reset_time"/>
        </dl_settings>
      </dl_settings>
    </dl_settings>

  </settings>
  <dep>
    <depends>guidance_indi_hybrid</depends>
    <conflicts>
      guidance_indi_hybrid_quadplane,
      guidance_indi_hybrid_tailsitter
    </conflicts>
    <provides>guidance,attitude_command</provides>
  </dep>
  <header>
    <file name="guidance_indi_hybrid_fixedwing_soaring.h"/>
  </header>

  <init fun="guidance_indi_soaring_init()"/>
  <init fun="guidance_indi_soaring_enter()"/>
  <periodic fun="run_soaring_search()" freq="100" autorun="TRUE"/>

  <makefile target="ap|nps" firmware="rotorcraft">
    <define name="GUIDANCE_INDI_SOARING" value="TRUE"/>
<!--    <define name="GUIDANCE_INDI_HYBRID_USE_WLS" value="FALSE"/>-->

    <!-- Guidance actuators: (roll, pitch, thrust) for fixed-wing  -->
    <!-- Yaw is set from navigation / seperated reference -->
    <define name="GUIDANCE_INDI_HYBRID_U" value="3"/>
    <define name="GUIDANCE_INDI_HYBRID_U_REDUCED" value="2"/>
    <!-- Guidance control objectives: ax, ay, ay -->
    <define name="GUIDANCE_INDI_HYBRID_V" value="3"/>
    <define name="GUIDANCE_INDI_HYBRID_V_REDUCED" value="2"/>
    <file name="guidance_indi_hybrid_fixedwing_soaring.c" dir="$(SRC_FIRMWARE)/guidance"/>
  </makefile>
</module>
