<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="bebop2_optitrack">
  <description>
    Airframe file to fly a Bebop2 drone, in stable smooth flight, through waypoints using an optitrack system, such as the Cyberzoo of TUDelft. The values are tuned so that the flight speed is limited and the drone does not over-shoot the waypoints as it would in outdoor settings.
  </description>

  <firmware name="rotorcraft">
    <target name="ap" board="bebop2"/>

    <target name="nps" board="pc">
      <module name="fdm" type="jsbsim"/>
      <module name="udp"/>  
    </target>
    
    <define name="USE_SONAR" value="FALSE"/>

    <!-- Subsystem section -->
    <module name="telemetry" type="transparent_udp"/>
    <module name="radio_control" type="datalink"/>
    <module name="motor_mixing"/>
    <module name="actuators" type="bebop"/>
    <module name="imu" type="bebop"/>
    <module name="gps" type="datalink"/>
    <!-- TODO: test this module -->
    <module name="follow_me">
      <define name="FOLLOW_ME_DISTANCE" value="60"/>
      <define name="FOLLOW_ME_HEIGHT" value="40"/>
    </module>
    <module name="guidance" type="indi_hybrid">
      <define name="NO_AIRSPEED_SENSOR"/>
      <define name="DRONE_WITHOUT_WING"/>
      <define name="GUIDANCE_INDI_RC_DEBUG" value="FALSE"/>
      <define name="GUIDANCE_INDI_POS_GAIN" value="0.2"/>
      <define name="GUIDANCE_INDI_SPEED_GAIN" value="5"/>
      <define name="GUIDANCE_INDI_POS_GAINZ" value="0.3"/>
      <define name="GUIDANCE_INDI_SPEED_GAINZ" value="0.5"/>
      <define name="GUIDANCE_INDI_PITCH_LIFT_EFF" value="0.0"/>
      <define name="GUIDANCE_INDI_PITCH_EFF_SCALING" value="0.0"/>
      <define name="GUIDANCE_H_REF_MAX_SPEED" value="5.0"/> <!--not used-->
      <define name="GUIDANCE_INDI_MAX_AIRSPEED" value="5.0"/>
      <define name="GUIDANCE_HEADING_IS_FREE" value="TRUE"/> <!--heading can not be set by navigation-->
      <define name="GUIDANCE_INDI_HEADING_BANK_GAIN" value="1"/>
      <!--define name="GUIDANCE_INDI_SPECIFIC_FORCE_GAIN" value="-943.0"/>
      <define name="GUIDANCE_INDI_SPECIFIC_FORCE_GAIN_45" value="-500.0"/>
      <define name="GUIDANCE_INDI_SPECIFIC_FORCE_GAIN_FWD" value="-1600.0"/-->
      <define name="GUIDANCE_INDI_FILTER_CUTOFF" value="0.5"/>
      <!--define name="GUIDANCE_INDI_LINE_GAIN" value="0.2"/-->
      <define name="GUIDANCE_INDI_MIN_THROTTLE" value="1500"/>
      <define name="GUIDANCE_INDI_MIN_THROTTLE_FWD" value="1500"/>
      <define name="GUIDANCE_INDI_LIFTD_P50" value="0.0"/>
      <define name="GUIDANCE_INDI_LIFTD_P80" value="0.0"/>
      <define name="GUIDANCE_INDI_LIFTD_ASQ" value="0.0"/>
      <define name="GUIDANCE_INDI_THRUST_DYNAMICS" value="0.06"/> <!-- not sure if needed for hybrid -->
    </module>
    <module name="stabilization" type="indi_simple"/>
    <module name="ahrs" type="int_cmpl_quat">
      <configure name="USE_MAGNETOMETER" value="FALSE"/>
      <define name="AHRS_USE_GPS_HEADING" value="TRUE"/>
    </module>
    <module name="ins" type="extended"/>
    <module name="geo_mag"/>
    <module name="air_data"/>
    <module name="send_imu_mag_current"/>
    <module name="approach_moving_target"/><!-- added by andreas 22-09-2022 -->
      <define name="AMT_ERR_SLOWDOWN_GAIN" value="true"/><!-- added by andreas 22-09-2022 -->
  </firmware>
  
  <commands>
    <axis name="PITCH" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="0"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="6000"/>
  </commands>

  <servos driver="Default">
    <servo name="TOP_LEFT" no="0" min="2500" neutral="2500" max="12000"/>
    <servo name="TOP_RIGHT" no="1" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_RIGHT" no="2" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_LEFT" no="3" min="2500" neutral="2500" max="12000"/>
  </servos>

  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    <define name="REVERSE" value="TRUE"/>
    <define name="TYPE" value="QUAD_X"/>
  </section>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
    <set servo="TOP_LEFT" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
    <set servo="TOP_RIGHT" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
    <set servo="BOTTOM_RIGHT" value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
    <set servo="BOTTOM_LEFT" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
  </command_laws>

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="FALSE"/>
    <define name="CALC_TAS_FACTOR" value="FALSE"/>
    <define name="CALC_AMSL_BARO" value="TRUE"/>
  </section>

  <section name="IMU" prefix="IMU_">
    <!-- Magneto calibration -->
    <define name="MAG_X_NEUTRAL" value="-16"/>
    <define name="MAG_Y_NEUTRAL" value="55"/>
    <define name="MAG_Z_NEUTRAL" value="204"/>
    <define name="MAG_X_SENS" value="7.28514789391" integer="16"/>
    <define name="MAG_Y_SENS" value="7.33022132691" integer="16"/>
    <define name="MAG_Z_SENS" value="7.57102035692" integer="16"/>
  </section>
  
  <include href="conf/airframes/ShipLanding/calibrations/BB2_IMU_ACCEL_bebopErik.xml"/> <!-- Accelerometer for attitude -->
  
  <!-- local magnetic field -->
  <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <!-- Toulouse -->
    <!--define name="H_X" value="0.513081"/>
    <define name="H_Y" value="-0.00242783"/>
    <define name="H_Z" value="0.858336"/-->
    <!-- Delft -->
    <define name="H_X" value="0.3892503"/>
    <define name="H_Y" value="0.0017972"/>
    <define name="H_Z" value="0.9211303"/>
    <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
  </section>

  <section name="INS" prefix="INS_">
    <define name="SONAR_MAX_RANGE" value="2.2"/>
    <define name="SONAR_MIN_RANGE" value="0.2"/>
    <define name="USE_GPS_ALT" value="1"/>
    <define name="USE_GPS_ALT_SPEED" value="1"/>
    <define name="VFF_R_GPS" value="0.01"/>
  </section>


  <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoint limits for attitude stabilization rc flight -->
    <define name="SP_MAX_PHI" value="45" unit="deg"/>
    <define name="SP_MAX_THETA" value="45" unit="deg"/>
    <define name="SP_MAX_R" value="300" unit="deg/s"/>
    <define name="DEADBAND_A" value="0"/>
    <define name="DEADBAND_E" value="0"/>
    <define name="DEADBAND_R" value="50"/>
  </section>

  <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <!-- attitude reference generation model -->
    <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.9"/>
    <define name="REF_MAX_P" value="600." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.9"/>
    <define name="REF_MAX_Q" value="600." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_R" value="450" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.9"/>
    <define name="REF_MAX_R" value="600." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(8000.)"/>
  </section>

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness -->
    <define name="G1_P" value="0.05"/>
    <define name="G1_Q" value="0.025"/>
    <define name="G1_R" value="0.0022"/>
    <define name="G2_R" value="0.20"/>

    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="170.0"/>
    <define name="REF_ERR_Q" value="600.0"/>
    <define name="REF_ERR_R" value="600.0"/>
    <define name="REF_RATE_P" value="14.3"/>
    <define name="REF_RATE_Q" value="28.0"/>
    <define name="REF_RATE_R" value="28.0"/>

    <!-- second order filter parameters -->
    <define name="FILT_CUTOFF" value="3.2"/>
    <define name="FILT_CUTOFF_RDOT" value="3.2"/>

    <!-- first order actuator dynamics -->
    <define name="ACT_DYN_P" value="0.06"/>
    <define name="ACT_DYN_Q" value="0.06"/>
    <define name="ACT_DYN_R" value="0.06"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="350"/>
    <define name="HOVER_KD" value="85"/>
    <define name="HOVER_KI" value="20"/>
    <define name="NOMINAL_HOVER_THROTTLE" value="0.53"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="TRUE"/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <!-- Good weather -->
    <define name="MAX_BANK" value="20" unit="deg"/>
    <define name="REF_MAX_SPEED" value="0.5" unit="m/s"/>
    <!-- Bad weather -->
    <!-- define name="MAX_BANK" value="32" unit="deg"/ -->
    <define name="PGAIN" value="120"/>
    <define name="DGAIN" value="100"/>
    <define name="IGAIN" value="30"/>
    <define name="REF_ZETA" value="1.0"/> <!-- 1.0 or more for no overshooting -->
  </section>

  <section name="MISC">
    <define name="ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/> <!-- how far away it declares that the waypoint is reached -->
  </section>

  <section name="IMU" prefix="IMU_">
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="0." unit="deg"/>
  </section>

  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="0.5"/>
    <define name="DESCEND_VSPEED" value="-1.0"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="nw_motor, ne_motor, se_motor, sw_motor" type="string[]"/>
    <define name="JSBSIM_MODEL" value="simple_x_quad_ccw" type="string"/>
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
  </section>

  <section name="AUTOPILOT">
    <define name="MODE_STARTUP" value="AP_MODE_NAV"/>
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_Z_HOLD"/>
    <define name="MODE_AUTO2" value="AP_MODE_NAV"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
  </section>

  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="8700"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.9" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="11.0" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="11.1" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="12.4" unit="V"/>
  </section>

  <!-- TODO: test this module with guidance_indi_hybrid -->
  <section name="FORWARD">
    <!--The Nederdrone uses a slightly different axis system for the setpoint, to make both hovering and flying forward intuitive-->
    <!--define name="USE_EARTH_BOUND_RC_SETPOINT" value="TRUE"/-->
    <define name="USE_EARTH_BOUND_RC_SETPOINT" value="FALSE"/>
    <!-- This is the pitch angle that the Nederdrone will have in forward flight, where 0 degrees is hover-->
    <!--define name="TRANSITION_MAX_OFFSET" value="-80.0" unit="deg"/-->
    <define name="TRANSITION_MAX_OFFSET" value="0.0" unit="deg"/>
    <!-- For RC coordinated turns, lower because the yawing was too slow -->
    <!--define name="MAX_FWD_SPEED" value="20.0"/-->
    <define name="MAX_FWD_SPEED" value="5.0"/>
    <!-- For hybrid guidance -->
    <!--define name="MAX_AIRSPEED" value="20.0"/-->
    <define name="MAX_AIRSPEED" value="5.0"/>
    <!-- Enable airspeed measurements -->
    <!--define name="USE_AIRSPEED" value="TRUE"/-->
    <define name="USE_AIRSPEED" value="FALSE"/>
  </section>
</airframe>
