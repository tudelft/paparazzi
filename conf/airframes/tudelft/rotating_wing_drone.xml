<airframe NAME="rotplane">
    <description>Rotating Wing Plane</description>
    <firmware NAME="rotorcraft">

        <target NAME="ap" BOARD="px4fmu_5.0_chibios">
            <configure VALUE="500" NAME="PERIODIC_FREQUENCY"/>
            <configure VALUE="SWD" NAME="FLASH_MODE"/>
            <module TYPE="sbus" NAME="radio_control">
                <configure VALUE="UART3" NAME="SBUS_PORT"/>
                <define VALUE="RADIO_AUX1" NAME="RADIO_KILL_SWITCH"/>
                <define VALUE="RADIO_AUX1" NAME="RADIO_TH_HOLD"/>
            </module>
            <!--Logger-->
            <module NAME="tlsf"/>
            <module NAME="pprzlog"/>
            <module TYPE="sd_chibios" NAME="logger"/>
            <module NAME="flight_recorder"/>
        </target>

        <module TYPE="transparent" NAME="telemetry">
            <configure VALUE="B115200" NAME="MODEM_BAUD"/>
        </module>

        <module TYPE="pwm" NAME="actuators"/>
        <module TYPE="mpu6000" NAME="imu"/>
        <!--<module TYPE="ublox" NAME="gps"/>
        <module TYPE="ubx_ucenter" NAME="gps"/>-->

        <module name="gps" type="datalink"/>

        <module TYPE="indi" NAME="stabilization">
            <configure name="INDI_NUM_ACT" value="8"/>
        </module>

        <!--<module TYPE="ekf2" NAME="ins"/>-->

        <define name="USE_AHRS_GPS_ACCELERATIONS" value="TRUE"/>
        <module name="ahrs" type="int_cmpl_quat"> 
            <configure name="AHRS_USE_MAGNETOMETER" value="FALSE"/> 
            <define name="AHRS_USE_GPS_HEADING" value="TRUE"/>
            <define name="AHRS_MAG_UPDATE_ALL_AXIS" value="FALSE"/>
            <configure name="USE_MAGNETOMETER" value="FALSE"/>
            <define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="0" unit="m/s"/>
        </module>
        <module name="ins" type="extended"/>

        <module name="geo_mag"/>
        <module NAME="send_imu_mag_current"/>

        <module TYPE="pwm" NAME="actuators">
            <define VALUE="10" NAME="ACTUATORS_PWM_NB"/>
            <define VALUE="TRUE" NAME="USE_PWM9"/>
            <define VALUE="TRUE" NAME="USE_PWM10"/>
            <define VALUE="400" NAME="SERVO_HZ"/>
        </module>

        <!--<module NAME="mag_ist8310">
            <define VALUE="FALSE" NAME="MODULE_IST8310_UPDATE_AHRS"/>
            <configure VALUE="I2C3" NAME="MAG_IST8310_I2C_DEV"/>
        </module>-->

        <module name="airspeed" type="ms45xx_i2c">
            <define name="USE_I2C4"/>
            <define name="MS45XX_I2C_DEV" value="i2c4"/>
            <define name="MS45XX_PRESSURE_OFFSET" value="8469.572266"/>
            <define name="MS45XX_AIRSPEED_SCALE" value="2.0"/>
            <define name="USE_AIRSPEED" value="TRUE"/>
        </module>

        <module NAME="ctrl_effectiveness_scheduling_rotating_wing_drone"/>
        <module NAME="wing_rotation_controller">
            <define VALUE="3190" NAME="WING_ROTATION_POSITION_ADC_0"/>
            <define VALUE="550"  NAME="WING_ROTATION_POSITION_ADC_90"/>
            <define VALUE="-20000"  NAME="WING_ROTATION_P_GAIN"/>
            <define VALUE="9600"  NAME="WING_ROTATION_MAX_CMD"/>
            <define VALUe="300" NAME="WING_ROTATION_DEADZONE_PPRZ_CMD"/>
            <define VALUE="TRUE" NAME="USE_ADC_5"/>
            <define VALUE="TRUE" NAME="USE_ADC_6"/>
        </module>

        <module name="guidance" type="indi_hybrid">
            <define name="GUIDANCE_INDI_HYBRID_ROT_WING"/>
        </module>

        <module NAME="sys_mon"/>
        <module name="sys_id_chirp">
            <define name="CHIRP_ENABLED"     value="TRUE"/>
            <define name="CHIRP_USE_NOISE"   value="FALSE"/>
            <define name="CHIRP_EXPONENTIAL" value="FALSE"/>
            <define name="CHIRP_FADEIN"      value="TRUE"/>
         </module>
        <module name="sys_id_doublet"/>
        

    </firmware>

    <servos>
        <servo NO="0" NEUTRAL="1100" NAME="MOTOR_FRONT" MIN="1000" MAX="2000"/>
        <servo NO="1" NEUTRAL="1100" NAME="MOTOR_RIGHT" MIN="1000" MAX="2000"/>
        <servo NO="2" NEUTRAL="1100" NAME="MOTOR_BACK" MIN="1000" MAX="2000"/>
        <servo NO="3" NEUTRAL="1100" NAME="MOTOR_LEFT" MIN="1000" MAX="2000"/>
        <servo NO="4" NEUTRAL="1500" NAME="AIL_LEFT" MIN="1100" MAX="1900"/>
        <servo NO="5" NEUTRAL="1500" NAME="AIL_RIGHT" MIN="1100" MAX="1900"/>
        <servo NO="6" NEUTRAL="1500" NAME="VTAIL_LEFT" MIN="1100" MAX="1900"/>
        <servo NO="7" NEUTRAL="1500" NAME="VTAIL_RIGHT" MIN="1100" MAX="1900"/>
        <servo NO="8" NEUTRAL="1000" NAME="MOTOR_FWD" MIN="1000" MAX="2000"/>
        <servo NO="9" NEUTRAL="1507" NAME="WING_ROT" MIN="1000" MAX="2000"/>
    </servos>

    <commands>
        <axis NAME="ROLL" FAILSAFE_VALUE="0"/>
        <axis NAME="PITCH" FAILSAFE_VALUE="0"/>
        <axis NAME="YAW" FAILSAFE_VALUE="0"/>
        <axis NAME="THRUST" FAILSAFE_VALUE="0"/>
    </commands>

    <rc_commands>
        <set VALUE="@THROTTLE" COMMAND="THRUST"/>
        <set VALUE="@YAW" COMMAND="YAW"/>
        <set VALUE="@PITCH" COMMAND="PITCH"/>
        <set VALUE="@ROLL" COMMAND="ROLL"/>
    </rc_commands>

    <section PREFIX="MOTOR_MIXING_" NAME="MIXING">
        <define VALUE="0" NAME="TRIM_ROLL"/>
        <define VALUE="0" NAME="TRIM_PITCH"/>
        <define VALUE="0" NAME="TRIM_YAW"/>
        <define VALUE="QUAD_PLUS" NAME="TYPE"/>
    </section>

    <command_laws>
        <!--<let VAR="th_hold" VALUE="LessThan(RadioControlValues(RADIO_TH_HOLD), -4800)"/>-->
        <call fun="sys_id_doublet_add_values(autopilot_get_motors_on(),FALSE,values)"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[0] : -MAX_PPRZ" SERVO="MOTOR_FRONT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[1] : -MAX_PPRZ" SERVO="MOTOR_RIGHT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[2] : -MAX_PPRZ" SERVO="MOTOR_BACK"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[3] : -MAX_PPRZ" SERVO="MOTOR_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[4] : 0" SERVO="AIL_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[5] : 0" SERVO="AIL_RIGHT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[6] : 0" SERVO="VTAIL_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[7] : 0" SERVO="VTAIL_RIGHT"/>
        <set VALUE="autopilot_get_motors_on() ? actuator_thrust_bx_pprz : -MAX_PPRZ" SERVO="MOTOR_FWD"/>
        <set VALUE="wing_rotation.servo_pprz_cmd" SERVO="WING_ROT"/>
    </command_laws>

    <section NAME="MISC">
        <define VALUE="((3.3f/4096.0f) * 17.9024749557 * adc)" NAME="VoltageOfAdc(adc)"/>
        <define VALUE="TRUE" NAME="NO_RC_THRUST_LIMIT"/>
        <define VALUE="3.5" NAME="NAV_CLIMB_VSPEED"/>
        <define VALUE="-0.5" NAME="NAV_DESCEND_VSPEED"/>
        <define VALUE="10.0" NAME="ARRIVED_AT_WAYPOINT"/>
        <define VALUE="20" NAME="NO_GPS_LOST_WITH_DATALINK_TIME"/>
        <define VALUE="TRUE" NAME="NO_GPS_LOST_WITH_RC_VALID"/>
        <define VALUE="TRUE" NAME="USE_KILL_SWITCH_FOR_MOTOR_ARMING"/>
        <define VALUE="TRUE" NAME="NO_RC_THRUST_LIMIT"/>
    </section>

    <section PREFIX="IMU_" NAME="IMU">
        <define VALUE="1" NAME="MPU_CHAN_X"/>
        <define VALUE="0" NAME="MPU_CHAN_Y"/>
        <define VALUE="2" NAME="MPU_CHAN_Z"/>
        <define VALUE="-1" NAME="MPU_X_SIGN"/>
        <define VALUE="1" NAME="MPU_Y_SIGN"/>
        <define VALUE="1" NAME="MPU_Z_SIGN"/>
        <define VALUE="145" NAME="ACCEL_X_NEUTRAL"/>
        <define VALUE="52" NAME="ACCEL_Y_NEUTRAL"/>
        <define VALUE="9" NAME="ACCEL_Z_NEUTRAL"/>
        <define VALUE="4.700654855386415" NAME="ACCEL_X_SENS" INTEGER="16"/>
        <define VALUE="4.898790938271689" NAME="ACCEL_Y_SENS" INTEGER="16"/>
        <define VALUE="4.84846920056402" NAME="ACCEL_Z_SENS" INTEGER="16"/>
        <define name="MAG_X_NEUTRAL" value="-10"/>
	<define name="MAG_Y_NEUTRAL" value="-2"/>
	<define name="MAG_Z_NEUTRAL" value="15"/>
	<define name="MAG_X_SENS" value="13.381846583778266" integer="16"/>
	<define name="MAG_Y_SENS" value="11.574542838155065" integer="16"/>
	<define name="MAG_Z_SENS" value="10.328369665473552" integer="16"/>
        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_PHI"/>
        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_THETA"/>
        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_PSI"/>
    </section>

    <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
    <section name="AHRS" prefix="AHRS_">
        <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
        <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
        <define name="GRAVITY_HEURISTIC_FACTOR" value="0"/> 
        <!-- Delft -->
        <define name="H_X" value="0.3892503"/>
        <define name="H_Y" value="0.0017972"/>
        <define name="H_Z" value="0.9211303"/>
    </section>

    <section name="INS" prefix="INS_">
        <define name="USE_GPS_ALT" value="1"/>
        <define name="USE_GPS_ALT_SPEED" value="1"/>
        <define name="VFF_R_GPS" value="0.01"/>
    </section>    

      <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
        <!-- setpoints -->
        <define name="SP_MAX_PHI" value="25" unit="deg"/>
        <define name="SP_MAX_THETA" value="25" unit="deg"/>
        <define name="SP_MAX_R" value="45" unit="deg/s"/>
        <define name="DEADBAND_A" value="2"/>
        <define name="DEADBAND_E" value="2"/>
        <define name="DEADBAND_R" value="50"/>

        <!-- reference -->
        <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
        <define name="REF_ZETA_P" value="0.9"/>
        <define name="REF_MAX_P" value="600." unit="deg/s"/>
        <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
        <define name="REF_ZETA_Q" value="0.9"/>
        <define name="REF_MAX_Q" value="600." unit="deg/s"/>
        <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_R" value="200" unit="deg/s"/>
        <define name="REF_ZETA_R" value="0.9"/>
        <define name="REF_MAX_R" value="300." unit="deg/s"/>
        <define name="REF_MAX_RDOT" value="RadOfDeg(4000.)"/>
    </section>

    <section PREFIX="STABILIZATION_INDI_" NAME="STABILIZATION_ATTITUDE_INDI">
        <define name="G1_ROLL"      value="{0.00,   -12.8,   0.00,  12.8,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_PITCH"     value="{1.7,    0.00,   -1.7,   0.00,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_YAW"       value="{-0.115, 0.115,  -0.115, 0.115, 0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_THRUST"    value="{-0.34,   -0.34,   -0.34,   -0.34,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G2"           value="{-0.06,  0.06,   -0.06,  0.06,  0.0, 0.0, 0.0, 0.0}"/>

        <!-- reference acceleration for attitude control -->
        <define name="REF_ERR_P" value="150.0"/>
        <define name="REF_ERR_Q" value="150.0"/>
        <define name="REF_ERR_R" value="20.0"/>
        <define name="REF_RATE_P" value="18.0"/>
        <define name="REF_RATE_Q" value="18.0"/>
        <define name="REF_RATE_R" value="5.0"/>

        <!--Maxium yaw rate, to avoid instability-->
        <define name="MAX_R" value="50.0" unit="deg/s"/>

        <!-- second order filter parameters -->
        <define name="FILT_CUTOFF" value="1.5"/>
        <define name="FILT_CUTOFF_RDOT" value="1.5"/>
        <define name="ESTIMATION_FILT_CUTOFF" value="1.5"/>

        <define name="FILTER_YAW_RATE" value="TRUE"/>

        <!-- first order actuator dynamics -->
        <define name="ACT_DYN" value="{0.047, 0.047, 0.047, 0.047, 0.1, 0.1, 0.1, 0.1}"/>
        <define name="ACT_IS_SERVO" value="{0, 0, 0, 0, 1, 1, 1, 1}"/>

        <define name="WLS_PRIORITIES" value="{1000.f, 1000.f, 1.f, 100.f}"/>

        <!-- Adaptive Learning Rate -->
        <define name="USE_ADAPTIVE" value="FALSE"/>
        <define name="ADAPTIVE_MU" value="0.001"/>
    </section>

    <section name="ROT_WING_EFF_SCHEDULING" prefix="ROT_WING_SCHED_">
        <define name="G1_Q_90" value="{-2.45, 2.45}"/>
        <define name="Y_ARM_LENGTH" value="0.365"/>
        <define name="G1_AERO_CONST_P" value="{-0.03, -0.03, 0.0, 0.0}"/> <!--Wing rotation dependency on pitch not scheduled yet-->
        <define name="G1_AERO_CONST_Q" value="{-0.0001, -0.0001, -0.03, 0.0}"/> <!--estimated value, use adaptive for real value-->
        <define name="G1_AERO_CONST_R" value="{0.0, 0.0, 0.0, 0.03}"/> <!--estimated value, use adaptive for real value-->
        <define name="ROT_WING_SCHED_AIRSPEED_FILTER_CUTOFF" value="1.5"/>
    </section> 

    <section name="FORWARD">
    <!-- This is the pitch angle that the drone will have in forward flight, where 0 degrees is hover-->
        <define name="TRANSITION_MAX_OFFSET" value="0.0" unit="deg"/>
        <define name="GUIDANCE_HEADING_IS_FREE" value="FALSE"/>
    </section>

    <section name="GUIDANCE_INDI_HYBRID" prefix="GUIDANCE_INDI_">
        <define name="POS_GAIN" value="0.5"/>
        <define name="POS_GAINZ" value="0.5"/>
        <define name="SPEED_GAIN" value="1.8"/>
        <define name="SPEED_GAINZ" value="1.8"/>
        <define name="FILTER_CUTOFF" value="1.0"/>
        <define name="HEADING_BANK_GAIN" value="1."/>
        <define name="NAV_SPEED_MARGIN" value="0."/>
        <define name="MAX_AIRSPEED" value="4."/>
        <define name="PITCH_LIFT_EFF" value="0.0"/>
        <define name="MIN_THROTTLE" value="0."/>
        <define name="MIN_PITCH" value="-35."/>
        <define name="MAX_PITCH" value="35."/>
        <define name="MIN_THROTTLE_FWD" value="0."/>
    </section>

    <section name= "PUSHER">
        <define name="THRUST_BX_EFF" value="0.0016"/>
    </section>

    <section PREFIX="GUIDANCE_V_" NAME="GUIDANCE_V">
        <define VALUE="310" NAME="HOVER_KP"/>
        <define VALUE="130" NAME="HOVER_KD"/>
        <define VALUE="10" NAME="HOVER_KI"/>
        <define VALUE="0.5" NAME="NOMINAL_HOVER_THROTTLE"/>
        <define VALUE="FALSE" NAME="ADAPT_THROTTLE_ENABLED"/>
    </section>

    <section PREFIX="GUIDANCE_H_" NAME="GUIDANCE_H">
        <define VALUE="30" UNIT="deg" NAME="MAX_BANK"/>
        <define VALUE="TRUE" NAME="USE_SPEED_REF"/>
        <define VALUE="60" NAME="PGAIN"/>
        <define VALUE="100" NAME="DGAIN"/>
        <define VALUE="0" NAME="AGAIN"/>
        <define VALUE="20" NAME="IGAIN"/>
    </section>

    <section NAME="AUTOPILOT">
        <define VALUE="AP_MODE_ATTITUDE_DIRECT" NAME="MODE_MANUAL"/>
        <define VALUE="AP_MODE_ATTITUDE_DIRECT" NAME="MODE_AUTO1"/>
        <define VALUE="AP_MODE_NAV" NAME="MODE_AUTO2"/>
        <define VALUE="AP_MODE_ATTITUDE_DIRECT" NAME="MODE_STARTUP"/>
    </section>

    <section NAME="GCS">
        <define VALUE="flyingwing" NAME="AC_ICON"/>
        <define VALUE="2" NAME="ALT_SHIFT_PLUS_PLUS"/>
        <define VALUE="1" NAME="ALT_SHIFT_PLUS"/>
        <define VALUE="-1" NAME="ALT_SHIFT_MINUS"/>
    </section>

    <section NAME="BAT">
        <define VALUE="10.0" UNIT="V" NAME="CATASTROPHIC_BAT_LEVEL"/>
        <define VALUE="10.5" UNIT="V" NAME="CRITIC_BAT_LEVEL"/>
        <define VALUE="10.9" UNIT="V" NAME="LOW_BAT_LEVEL"/>
        <define VALUE="12.6" UNIT="V" NAME="MAX_BAT_LEVEL"/>
        <define VALUE="3" NAME="BAT_NB_CELLS"/>
    </section>
    
</airframe>
