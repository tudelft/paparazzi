<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="Outback">
  <description>Helicopter with a double wing as frame
     * Autopilot:   OPA/FTD 1.0 and OPA/AP 1.0 with STM32F4
     * IMU:         MPU6000 (FTD), MPU6000 (AP)
     * Baro:        MS5611 (AP)
     * Pitot+mag:   External in wing
     * Actuators:   10 PWM (FTD)
     * GPS:         UBlox M8N (AP), UBlox M8N (FTD)
     * RC:          R-XSR SBUS (RC2)
     * Telemetry:   868/900 MHz Long range (AP), Iridium (FTD)
  </description>

  <firmware name="rotorcraft">
    <!-- AP (autopilot) part of the board -->
    <target name="ap" board="opa_ap_1.0">
      <!--target name="nps" board="pc">
        <subsystem name="fdm" type="jsbsim"/>
      </target-->

      <module name="telemetry"     type="transparent">
        <configure name="MODEM_BAUD" value="B9600"/>
      </module>
      <module name="imu"           type="mpu6000"/>
      <module name="gps"           type="ublox">
        <define name="GPS_TIMEOUT" value="2"/>
      </module>
      <!--module name="sys_id_chirp"/-->
      <!--module name="sys_id_doublet"/-->
      <module name="stabilization" type="int_quat"/>
      <module name="stabilization" type="rate"/>
      <module name="ahrs"          type="int_cmpl_quat">
        <define name="AHRS_GRAVITY_UPDATE_COORDINATED_TURN" value="TRUE"/>      
      </module>
      <module name="ins"           type="hff_extended">
        <define name="USE_SONAR"                value="true"/>
        <define name="INS_SONAR_MAX_RANGE"      value="5"/>
        <define name="INS_SONAR_MIN_RANGE"      value="0.15"/>
        <define name="INS_SONAR_UPDATE_ON_AGL"  value="TRUE"/>
      </module>
      <module name="guidance"      type="delftacopter"/>
      <module name="guidance"      type="indi"/>
      <module name="gain_scheduling"/>
      <module name="intermcu"      type="uart">
        <configure name="SECONDARY_GPS" value="imcu"/>
      </module>
      <module name="telemetry"     type="intermcu"/>
      <module name="current_sensor"/>
      <module name="opa_controller"/>
      <module name="mag_pitot_uart" />
      <module name="pwm_meas"/>
      <module name="rpm_sensor">
        <define name="RPM_PULSE_PER_RND" value="21"/>
      </module>      
      <module name="vision_outback">
        <configure name="VISION_OUTBACK_PORT" value="UART4"/>
      </module>

      <module name="geo_mag"/>
      <module name="air_data">
        <define name="AIR_DATA_BARO_ABS_ID" value="IMU_MAG_PITOT_ID"/>
        <define name="AIR_DATA_TEMPERATURE_ID" value="IMU_MAG_PITOT_ID"/>
        <!--define name="AIR_DATA_BARO_ABS_ID" value="BARO_BOARD_SENDER_ID"/>
        <define name="AIR_DATA_TEMPERATURE_ID" value="BARO_BOARD_SENDER_ID"/-->
        <define name="AIR_DATA_CALC_AMSL_BARO" value="TRUE"/>
      </module>

      <module name="temp_adc"/>
      <module name="logger_sd_spi_direct">
        <define name="SDLOGGER_ON_ARM" value="TRUE"/>
      </module>
      <module name="gps_ubx_ucenter"/>
      <module name="heli_throttle_curve"/>
      <define name="ROTORCRAFT_IS_HELI" value="TRUE" />
      <define name="RC_LOST_MODE" value="AP_MODE_NAV" />
    </target>

    <!-- FBW (Flight by Wire) part of the board -->
    <target name="fbw" board="opa_ftd_1.0">

      <module name="radio_control" type="sbus"/>
      <module name="actuators"     type="pwm">
        <define name="SERVO_HZ"    value="300"/>
      </module>
      <module name="intermcu"      type="uart">
        <define name="IMCU_GPS_ID" value="GPS_UBX_ID"/>
      </module>
      <module name="telemetry"     type="intermcu"/>
      <module name="opa_controller"/>
      <module name="heli_swashplate_mixing"/>
      <module name="gps" type="ublox"/>
      <module name="gps_ubx_ucenter"/>

      <define name="RC_LOST_FBW_MODE" value="FBW_MODE_FAILSAFE"/><!-- Switch to Failsafe or to Autopilot on RC loss? -->
      <define name="RC_LOST_IN_AUTO_FBW_MODE" value="FBW_MODE_AUTO"/><!-- Switch to Failsafe with a working autopilot on RC loss? -->
      <define name="AP_LOST_FBW_MODE" value="FBW_MODE_MANUAL"/><!-- Switch to Failsafe or to Manual on AP loss? -->
    </target>
  </firmware>

  <!-- Based on 4A load 18650 6S6P for AP (ideally change for FBW) -->
  <section name="BAT">
    <define name="CATASTROPHIC_BAT_LEVEL" value="18.0" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="18.6" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="19.2" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="25.2" unit="V"/>
  </section>

  <servos driver="Pwm">
    <servo name="THROTTLE"       no="0" min="1000" neutral="1000" max="2000"/>
    <servo name="SW_BACK"        no="1" min="1900" neutral="1500" max="1100"/>
    <servo name="SW_LEFTFRONT"   no="2" min="1100" neutral="1500" max="1900"/>
    <servo name="SW_RIGHTFRONT"  no="3" min="1900" neutral="1500" max="1100"/>
    <servo name="TAIL_LEFT"      no="4" min="1100" neutral="1500" max="1900"/>
    <servo name="TAIL_RIGHT"     no="5" min="1100" neutral="1500" max="1900"/>
    <servo name="AIL_LEFTLOW"    no="6" min="1060" neutral="1460" max="1860"/>
    <servo name="AIL_RIGHTLOW"   no="7" min="1140" neutral="1540" max="1940"/>
    <servo name="AIL_LEFTUP"     no="8" min="1100" neutral="1500" max="1900"/>
    <servo name="AIL_RIGHTUP"    no="9" min="1100" neutral="1500" max="1900"/>
  </servos>

  <!-- T-Motor 190kv with 24.2 inch prop -->
  <!-- * Top linkages circa 59.7 mm
       * Distance from the bottom the the upper-swashplate rotation-link ball-rodds to the bottom of the blade grip just above is circa 56.2 mm.
       * The servo is about 30deg down in failsafe, where its bolt aligns with the 2 servo fixing bolts
       * The top of the rotorhead should be 90.0mm (2OI) 88.1mm (3MM) 89.3mm (4HP)
       * There should be at least 3mm below the swashplate up to 5mm with the 90.0mm rotoraxis
       * This should correspond to the blade grip ball to be aligned with the rotorhead-T fixation bolt
       * This should correspong to a blade grip or blade root angle of -17 degrees
  -->

  <section name="GCS">
    <define name="SPEECH_NAME" value="Two Oscar India"/>
    <define name="AC_ICON" value="flyingwing"/>
  </section>

  <!-- Direct RC commands conversion for FBW -->
  <rc_commands>
    <set command="THRUST"       value="@THROTTLE"/>
    <set command="COLLECTIVE"   value="@THROTTLE-MAX_PPRZ"/>
    <set command="ROLL"         value="@ROLL"/>
    <set command="PITCH"        value="@PITCH"/>
    <set command="YAW"          value="@YAW"/>
    <set command="ELEVATOR"     value="@PITCH"/>
    <set command="AILERON"      value="@ROLL"/>
  </rc_commands>

  <!-- Commands send from AP to FBW -->
  <commands>
    <axis name="THRUST"     failsafe_value="0"/>
    <axis name="ROLL"       failsafe_value="0"/>
    <axis name="PITCH"      failsafe_value="0"/>
    <axis name="YAW"        failsafe_value="0"/>
    <axis name="COLLECTIVE" failsafe_value="-9600"/>
    <axis name="ELEVATOR"   failsafe_value="0"/>
    <axis name="AILERON"    failsafe_value="0"/>
  </commands>

  <!-- Swashplate mixing HR120 (1 Back, 2 Front at 120 degree) -->
  <section name="MIXING" prefix="SW_MIXING_">
    <define name="TYPE"       value="HR120"/>
    <define name="TRIM_ROLL"  value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_COLL"  value="0"/>
  </section>

  <!-- Throttle curve RPM controller -->
  <section name="THROTTLE_CURVE" prefix="THROTTLE_CURVE_">
    <define name="RPM_FB_P"       value="3.0"/>
    <define name="RPM_FB_I"       value="3.0"/>
    <define name="RPM_INC_LIMIT"  value="2048"/>
  </section>

  <!-- Convert commands to PWM -->
  <command_laws>
    <!-- Run swashplate mixing and define variables -->
    <call fun="swashplate_mixing_run(values)"/>
    <let var="th_hold"          value="LessThan(RadioControlValues(RADIO_TH_HOLD), -4800)"/>

    <!-- Enable or disable the tip propellors on an interMCU command -->
    <let var="forward_curve"    value="INTERMCU_GET_CMD_STATUS(INTERMCU_CMD_TIPPROPS)"/>
    <call fun="INTERMCU_CLR_CMD_STATUS(INTERMCU_CMD_TIPPROPS)"/>

    <!-- Output the PWM values -->
    <set servo="THROTTLE"       value="($th_hold? -9600 : @THRUST)"/>
    <set servo="SW_BACK"        value="swashplate_mixing.commands[SW_BACK]"/>
    <set servo="SW_LEFTFRONT"   value="swashplate_mixing.commands[SW_LEFTFRONT]"/>
    <set servo="SW_RIGHTFRONT"  value="swashplate_mixing.commands[SW_RIGHTFRONT]"/>
    <set servo="TAIL_LEFT"      value="(Or($th_hold, $forward_curve)? 0 : (-@YAW - @THRUST*0.25) )"/>
    <set servo="TAIL_RIGHT"     value="(Or($th_hold, $forward_curve)? 0 : (-@YAW - @THRUST*0.25) )"/>
    <set servo="AIL_LEFTLOW"    value=" 1*@ELEVATOR + 1.5*@AILERON"/>
    <set servo="AIL_RIGHTLOW"   value="-1*@ELEVATOR + 1.5*@AILERON"/>
    <set servo="AIL_LEFTUP"     value=" 1*@ELEVATOR + 1.5*@AILERON"/>
    <set servo="AIL_RIGHTUP"    value="-1*@ELEVATOR + 1.5*@AILERON"/>
  </command_laws>

  <!-- T-Motor 190kv with 24.2 inch prop -->
  <heli_curves>
    <curve throttle="0,6000,0,0,0" collective="-9600,-8150,-6700,-5250,-3800"/> <!-- Spinup curve -->
    <curve throttle="7300,7800,8300" rpm="2800,2800,2800" collective="-9600,-6500,-2300"/><!-- Hover curve RPM controlled -->
    <curve throttle="7300,7800,8300" rpm="2800,2800,2800" collective="-9600,-6500,-2300"/><!-- Hover curve RPM controlled -->
    <curve throttle="8600,8600,8600,8600,9600" collective="-9600,-9600,-7470,-3770,30"/><!-- Forward inefficient curve -->
    <curve throttle="5000,5000,5000,5000,5300" collective="-9600,-6300,-3000,700,4500"/><!-- Forward curve -->
  </heli_curves>

  <section name="MISC">
    <define name="NAV_CLIMB_VSPEED" value="3.0"/>
    <define name="NAV_DESCEND_VSPEED" value="-3.5"/>
    <define name="NAV_LINE_FOLLOWING_DIST" value="160.0"/>
    <define name="ARRIVED_AT_WAYPOINT" value="50"/>
    <define name="ARRIVED_AT_WAYPOINT_HOVER" value="5"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
    <define name="NO_GPS_LOST_WITH_RC_VALID" value="TRUE"/>
    <define name="APVoltageOfAdc(adc)" value="(adc*0.0061456 + 0.321688)"/>
    <define name="MilliAmpereOfAdc(_adc)" value="(DefaultMilliAmpereOfAdc(_adc) + 417 - 100)"/>
    <define name="TRANSITION_MAX_OFFSET" value="-83.0" unit="deg"/>
    <define name="USE_EARTH_BOUND_RC_SETPOINT" value="TRUE"/>
  </section>

  <section name="IMU" prefix="IMU_">
    <define name="ACCEL_X_NEUTRAL" value="11"/>
    <define name="ACCEL_Y_NEUTRAL" value="11"/>
    <define name="ACCEL_Z_NEUTRAL" value="-25"/>

    <!-- Calibration 21-09-2018 dalby test field total setup with extra USB -->
    <define name="MAG_X_NEUTRAL" value="-1"/>
    <define name="MAG_Y_NEUTRAL" value="7"/>
    <define name="MAG_Z_NEUTRAL" value="1"/>
    <define name="MAG_X_SENS" value="16.5514602014" integer="16"/>
    <define name="MAG_Y_SENS" value="15.4152361724" integer="16"/>
    <define name="MAG_Z_SENS" value="15.3826558014" integer="16"/>

    <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI"   value="180." unit="deg"/>

    <!-- Rotate magneto compared to imu -90 degress -->
    <define name="TO_MAG_PHI"   value="0." unit="deg"/>
    <define name="TO_MAG_THETA" value="0." unit="deg"/>
    <define name="TO_MAG_PSI"   value="90." unit="deg"/>

    <!-- Change sign to fix axis -->
    <define name="MAG_X_SIGN" value="1"/>
    <define name="MAG_Y_SIGN" value="1"/>
    <define name="MAG_Z_SIGN" value="1"/>
  </section>

  <section name="AHRS" prefix="AHRS_">
    <define name="GPS_SPEED_IN_NEGATIVE_Z_DIRECTION" value="true"/>

    <!--This airframe vibrates a lot, which causes accel measurements in excess of 1g continuously-->
    <define name="GRAVITY_HEURISTIC_FACTOR" value="0"/>
    <define name="PROPAGATE_LOW_PASS_RATES" value="TRUE"/>
    <define name="PROPAGATE_LOW_PASS_RATES_MUL" value="19"/>
    <define name="PROPAGATE_LOW_PASS_RATES_DIV" value="20"/>

    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <define name="H_X" value="0.5293"/>
    <define name="H_Y" value="0.0971"/>
    <define name="H_Z" value="-0.8429"/>
  </section>

  <!-- The advance angles for the rotorhead, P and Q couplings -->
  <section name="STABILIZATION" prefix="STABILIZATION_">
    <define name="ADVANCE_ANGLE_P" value="0.9"/>
    <define name="ADVANCE_ANGLE_Q" value="0.5"/>
  </section>

  <!-- Rate controller gains for development -->
  <section name="STABILIZATION_RATE" prefix="STABILIZATION_RATE_">
    <!-- setpoints -->
    <define name="SP_MAX_P" unit="deg/s" value="280"/>
    <define name="SP_MAX_Q" unit="deg/s" value="350"/>
    <define name="SP_MAX_R" unit="deg/s" value="200"/>
    <define name="DEADBAND_P" value="20"/>
    <define name="DEADBAND_Q" value="20"/>
    <define name="DEADBAND_R" value="200"/>

    <!-- feedback -->
    <define name="GAIN_P" value="880"/>
    <define name="GAIN_Q" value="880"/>
    <define name="GAIN_R" value="4100"/>

    <!-- integrator gains -->
    <define name="IGAIN_P" value="0"/>
    <define name="IGAIN_Q" value="0"/>
    <define name="IGAIN_R" value="50"/>
  </section>

  <!-- Attitude controller gains in hover (are they used????) -->
  <section name="STABILIZATION_ATTITUDE" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoints -->
    <define name="SP_MAX_PHI" value="60." unit="deg"/>
    <define name="SP_MAX_THETA" value="60." unit="deg"/>
    <define name="SP_MAX_R" value="150." unit="deg/s"/>
    <define name="DEADBAND_R" value="200"/>

    <!-- reference -->
    <define name="REF_OMEGA_P" value="500" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.85"/>
    <define name="REF_MAX_P" value="300." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(7000.)"/>
    <define name="REF_OMEGA_Q" value="800" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.85"/>
    <define name="REF_MAX_Q" value="300." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(7000.)"/>
    <define name="REF_OMEGA_R" value="500" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.85"/>
    <define name="REF_MAX_R" value="180." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(1800.)"/>

    <!-- feedback -->
    <define name="PHI_PGAIN" value="854"/>
    <define name="PHI_DGAIN" value="369"/>
    <define name="PHI_IGAIN" value="180"/>
    <define name="THETA_PGAIN" value="1605"/>
    <define name="THETA_DGAIN" value="293"/>
    <define name="THETA_IGAIN" value="180"/>
    <define name="PSI_PGAIN" value="500"/>
    <define name="PSI_DGAIN" value="1360"/>
    <define name="PSI_IGAIN" value="151"/>

    <!-- feedforward -->
    <define name="PHI_DDGAIN" value="0"/>
    <define name="THETA_DDGAIN" value="0"/>
    <define name="PSI_DDGAIN" value="0"/>
  </section>

  <!-- Gain sets for hover and forward based on the throttle curve -->
  <section name="GAIN_SETS">
    <define name="NUMBER_OF_GAINSETS" value="2"/>
    <define name="SCHEDULING_VARIABLE" value="throttle_curve.mode"/>
    <define name="SCHEDULING_POINTS" value="{2.4, 2.5}"/>
    <define name="SCHEDULING_VARIABLE_FRAC" value="0"/>

    <define name="PHI_P" value="{854, 458}"/>
    <define name="PHI_D" value="{369, 293}"/>
    <define name="PHI_I" value="{180, 0}"/>
    <define name="PHI_DD" value="{0, 0}"/>

    <define name="THETA_P" value="{990, 850}"/>
    <define name="THETA_D" value="{265, 160}"/>
    <define name="THETA_I" value="{180, 200}"/>
    <define name="THETA_DD" value="{0, 0}"/>

    <define name="PSI_P" value="{500, 800}"/>
    <define name="PSI_D" value="{1360, 432}"/>
    <define name="PSI_I" value="{151, 151}"/>
    <define name="PSI_DD" value="{0, 0}"/>
  </section>

  <!-- Vertical gains in hover mode -->
  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP"    value="75"/>
    <define name="HOVER_KD"    value="40"/>
    <define name="HOVER_KI"    value="12"/>
    <define name="NOMINAL_HOVER_THROTTLE" value="0.61"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="FALSE"/>
    <define name="REF_MAX_ZD" value="1.5"/>
  </section>

  <!-- INDI guidance controller for hover mode -->
  <section name="GUIDANCE_INDI" prefix="GUIDANCE_INDI_">
    <define name="POS_GAIN_XY" value="0.3"/>
    <define name="POS_GAIN_Z" value="0.3"/>
    <define name="SPEED_GAIN_XY" value="1.0"/>
    <define name="SPEED_GAIN_Z" value="1.0"/>
    <define name="FILTER_CUTOFF" value="0.8"/>
  </section>

  <!-- Horizontal gains in hover mode -->
  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <define name="MAX_PHI" value="17" unit="deg"/>
    <define name="MAX_THETA" value="23" unit="deg"/>
    <define name="USE_SPEED_REF" value="TRUE"/>
    <define name="REF_MAX_SPEED" value="15" />
    <define name="PGAIN" value="20"/>
    <define name="DGAIN" value="40"/>
    <define name="AGAIN" value="30"/>
    <define name="IGAIN" value="10"/>
  </section>

  <!-- gains for delftacopter control -->
  <section name="DC_" prefix="DC_">
    <define name="HOVER_THROTTLE_CURVE" value="2"/>
    <define name="TRANSITION_THROTTLE_CURVE" value="3"/>
    <define name="FORWARD_THROTTLE_CURVE" value="4"/>
    <define name="TRANSITION_TIME" value="2"/>
    <define name="TRANSITION_THROTTLE_TO_FORWARD" value="8500"/>
    <define name="TRANSITION_THROTTLE_TO_HOVER" value="4800"/>
  </section>

  <!-- Gains for forward mode -->
  <section name="DC_FORWARD" prefix="DC_FORWARD_">
    <define name="MAX_AIRSPEED" value="18.0"/>
    <define name="NOMINAL_THRUST" value="7400"/>
    <define name="VERTICAL_PGAIN" value="0.1"/>
    <define name="VERTICAL_DGAIN" value="0.015"/>
    <define name="VERTICAL_LOW_AIRSPEED" value="17.0"/>
    <define name="VERTICAL_LOW_AIRSPEED_PITCH_GAIN" value="0.0"/>
    <define name="MAX_TURN_BANK" value="35.0"/>
    <define name="TURN_BANK_GAIN" value="0.5"/>
    <define name="PITCH_OF_ROLL" value="0.02"/>
    <define name="THROTTLE_FROM_PITCH_UP" value="50.0"/>
    <define name="MIN_PITCH" value="-15.0"/>
    <define name="MAX_PITCH" value="10.0"/>
    <define name="MAX_PSI" value="20.0"/>
    <define name="ACC_Y_FILTER_CUTOFF_HZ" value="0.5"/>
    <define name="E_PSI_DEG_FROM_ACC_Y" value="0"/>
    
    <define name="ROLL_PGAIN" value="3000.0"/>
    <define name="ROLL_DGAIN" value="200.0"/>
    <define name="ROLL_IGAIN" value="0.2"/>
    <define name="ROLL_TRIM" value="0.0"/>
    <define name="PITCH_PGAIN" value="2500.0"/>
    <define name="PITCH_DGAIN" value="1000.0"/>
    <define name="PITCH_IGAIN" value="0.5"/>
    <define name="PITCH_TRIM" value="1200"/>
    <define name="K_FF_TO_YAW" value="600.0"/> <!-- order of magnitude -->
    <define name="ADVANCE_P" value="1.1"/>
    <define name="ADVANCE_Q" value="1.1"/>
    <define name="PITCH_SWP" value="0.0"/>
  </section>

  <!-- Radio control specific switches -->
  <section name="RADIO" prefix="RADIO_">
    <define name="TH_HOLD"    value="RADIO_AUX1"/> <!-- Throttle hold in command laws -->
    <define name="FMODE"      value="RADIO_AUX2"/> <!-- Throttle curve select -->
    <define name="FBW_MODE"   value="RADIO_AUX3"/> <!-- Switch between AP and FBW control -->
  </section>

  <!-- Different autopilot modes for the RC -->
  <section name="AUTOPILOT">
    <define name="MODE_MANUAL" value="AP_MODE_RATE_DIRECT"/>
    <define name="MODE_AUTO1"  value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO2"  value="AP_MODE_NAV"/>
  </section>

</airframe>
