<airframe NAME="rotplane">
    <description>Rotating Wing Plane</description>
    <firmware NAME="rotorcraft">

        <target NAME="ap" BOARD="px4fmu_5.0_chibios">
            <configure VALUE="500" NAME="PERIODIC_FREQUENCY"/>
            <configure VALUE="SWD" NAME="FLASH_MODE"/>
            <module TYPE="sbus" NAME="radio_control">
                <configure VALUE="UART3" NAME="SBUS_PORT"/>
                <define VALUE="RADIO_AUX1" NAME="RADIO_KILL_SWITCH"/>
                <define VALUE="RADIO_AUX1" NAME="RADIO_TH_HOLD"/>
            </module>

            <module NAME="ctrl_effectiveness_scheduling_rotating_wing_drone"/>
            <define VALUE="TRUE" NAME="USE_KILL_SWITCH_FOR_MOTOR_ARMING"/>
            <define name="USE_I2C4"/>
            <define name="MS45XX_I2C_DEV" value="i2c4"/>

            <!--Logger-->
            <module NAME="tlsf"/>
            <module NAME="pprzlog"/>
            <module TYPE="sd_chibios" NAME="logger"/>
            <module NAME="flight_recorder"/>
        </target>

        <target name="nps" board="pc">
            <module name="fdm" type="jsbsim"/>
            <module name="udp"/>
            <configure VALUE="500" NAME="PERIODIC_FREQUENCY"/>
            <module TYPE="datalink" NAME="radio_control"/>
	    <module NAME="ctrl_effectiveness_scheduling_rotating_wing_drone"/>
        </target>

        <module TYPE="transparent" NAME="telemetry">
            <configure VALUE="B115200" NAME="MODEM_BAUD"/>
        </module>

        <module TYPE="pwm" NAME="actuators"/>
        <module TYPE="mpu6000" NAME="imu"/>
        <!--<module TYPE="ublox" NAME="gps"/>-->
        <!--<module TYPE="ubx_ucenter" NAME="gps"/>-->

        <module name="gps" type="datalink"/>

        <module TYPE="indi" NAME="stabilization">
            <configure name="INDI_NUM_ACT" value="8"/>
        </module>

       <!-- <module TYPE="ekf2" NAME="ins"/> -->

        <define name="USE_AHRS_GPS_ACCELERATIONS" value="FALSE"/>
        <module name="ahrs" type="int_cmpl_quat"> 
            <configure name="AHRS_USE_MAGNETOMETER" value="FALSE"/> 
            <define name="AHRS_USE_GPS_HEADING" value="TRUE"/>
            <configure name="USE_MAGNETOMETER" value="FALSE"/>
            <define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="0" unit="m/s"/>
        </module>
        <module name="ins" type="extended"/>

        <module name="geo_mag"/>
        <module NAME="send_imu_mag_current"/>

        <section name="IMU" prefix="IMU_">
         <define name="BODY_TO_IMU_THETA" value="2." unit="deg"/>
         <define name="BODY_TO_IMU_PHI"   value="0." unit="deg"/>
         <define name="BODY_TO_IMU_PSI"   value="0." unit="deg"/>
       </section>
        
        <module TYPE="pwm" NAME="actuators">
            <define VALUE="10" NAME="ACTUATORS_PWM_NB"/>
            <define VALUE="TRUE" NAME="USE_PWM9"/>
            <define VALUE="TRUE" NAME="USE_PWM10"/>
            <define VALUE="400" NAME="SERVO_HZ"/>
        </module>

        <module NAME="mag_ist8310">
            <define name="IST8310_CHAN_X_SIGN" value="-"/>
            <define name="IST8310_CHAN_Z_SIGN" value="-"/>
            <define VALUE="FALSE" NAME="MODULE_IST8310_UPDATE_AHRS"/>
            <configure VALUE="I2C3" NAME="MAG_IST8310_I2C_DEV"/>
        </module>

        <module name="airspeed" type="ms45xx_i2c">
            <define name="MS45XX_PRESSURE_OFFSET" value="8469.572266"/>
            <define name="MS45XX_AIRSPEED_SCALE" value="2.0"/>
            <!--Gives cut-off freq of 1/(2*pi*tau) in 1Hz -->
            <define name="MS45XX_LOWPASS_TAU" value="0.25"/>  
            <define name="USE_AIRSPEED" value="TRUE"/>
        </module>

        <module NAME="wing_rotation_controller">
                <define VALUE="3100" NAME="WING_ROTATION_POSITION_ADC_0"/>
                <define VALUE="205"  NAME="WING_ROTATION_POSITION_ADC_90"/>
                <define VALUE="-20000"  NAME="WING_ROTATION_P_GAIN"/>
                <define VALUE="9600"  NAME="WING_ROTATION_MAX_CMD"/>
                <define VALUE="300" NAME="WING_ROTATION_DEADZONE_PPRZ_CMD"/>
                <define VALUE="9" NAME="WING_ROTATION_SERVO_IDX"/>
                <define VALUE="TRUE" NAME="USE_ADC_5"/>
                <define VALUE="TRUE" NAME="USE_ADC_6"/>
        </module>

        <module name="guidance" type="indi_hybrid">
            <define name="GUIDANCE_INDI_HYBRID_ROT_WING"/>
        </module>

        <module NAME="sys_mon"/>
        <module name="sys_id_chirp">
            <define name="CHIRP_ENABLED"     value="TRUE"/>
            <define name="CHIRP_USE_NOISE"   value="FALSE"/>
            <define name="CHIRP_EXPONENTIAL" value="FALSE"/>
            <define name="CHIRP_FADEIN"      value="TRUE"/>
         </module>
        <module name="sys_id_doublet"/>
        <module name="extended_eff_message"/>
        <module name="ctrl_interface"/>
        <!--<module name="project_target"/>-->
        

    </firmware>

    <servos>
        <servo NO="0" NEUTRAL="1100" NAME="MOTOR_FRONT" MIN="1000" MAX="2000"/>
        <servo NO="1" NEUTRAL="1100" NAME="MOTOR_RIGHT" MIN="1000" MAX="2000"/>
        <servo NO="2" NEUTRAL="1100" NAME="MOTOR_BACK" MIN="1000" MAX="2000"/>
        <servo NO="3" NEUTRAL="1100" NAME="MOTOR_LEFT" MIN="1000" MAX="2000"/>
        <servo NO="4" NEUTRAL="1500" NAME="AIL_LEFT" MIN="1100" MAX="1900"/>
        <servo NO="5" NEUTRAL="1500" NAME="AIL_RIGHT" MIN="1100" MAX="1900"/>
        <servo NO="6" NEUTRAL="1500" NAME="VTAIL_LEFT" MIN="1100" MAX="1900"/>
        <servo NO="7" NEUTRAL="1500" NAME="VTAIL_RIGHT" MIN="1100" MAX="1900"/>
        <servo NO="8" NEUTRAL="1035" NAME="MOTOR_FWD" MIN="1000" MAX="2000"/>
        <servo NO="9" NEUTRAL="1520" NAME="WING_ROT" MIN="1420" MAX="1620"/>
    </servos>

    <commands>
        <axis NAME="ROLL" FAILSAFE_VALUE="0"/>
        <axis NAME="PITCH" FAILSAFE_VALUE="0"/>
        <axis NAME="YAW" FAILSAFE_VALUE="0"/>
        <axis NAME="THRUST" FAILSAFE_VALUE="0"/>
    </commands>

    <rc_commands>
        <set VALUE="@THROTTLE" COMMAND="THRUST"/>
        <set VALUE="@YAW" COMMAND="YAW"/>
        <set VALUE="@PITCH" COMMAND="PITCH"/>
        <set VALUE="@ROLL" COMMAND="ROLL"/>
    </rc_commands>

    <section PREFIX="MOTOR_MIXING_" NAME="MIXING">
        <define VALUE="0" NAME="TRIM_ROLL"/>
        <define VALUE="0" NAME="TRIM_PITCH"/>
        <define VALUE="0" NAME="TRIM_YAW"/>
        <define VALUE="QUAD_PLUS" NAME="TYPE"/>
    </section>

    <command_laws>
        <!--<let VAR="th_hold" VALUE="LessThan(RadioControlValues(RADIO_TH_HOLD), -4800)"/>-->
        <!--<call fun="sys_id_doublet_add_values(autopilot_get_motors_on(),FALSE,values)"/>-->
        <set VALUE="And(autopilot_get_motors_on(), rot_wing_thrust_z_activated) ? actuators_pprz[0] : -MAX_PPRZ" SERVO="MOTOR_FRONT"/>
        <set VALUE="And(autopilot_get_motors_on(), rot_wing_thrust_z_activated) ? actuators_pprz[1] : -MAX_PPRZ" SERVO="MOTOR_RIGHT"/>
        <set VALUE="And(autopilot_get_motors_on(), rot_wing_thrust_z_activated) ? actuators_pprz[2] : -MAX_PPRZ" SERVO="MOTOR_BACK"/>
        <set VALUE="And(autopilot_get_motors_on(), rot_wing_thrust_z_activated) ? actuators_pprz[3] : -MAX_PPRZ" SERVO="MOTOR_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[4] : 0" SERVO="AIL_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[5] : 0" SERVO="AIL_RIGHT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[6] : 0" SERVO="VTAIL_LEFT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[7] : 0" SERVO="VTAIL_RIGHT"/>
        <set VALUE="autopilot_get_motors_on() ? actuators_pprz[8] : -MAX_PPRZ" SERVO="MOTOR_FWD"/>
        <set VALUE="wing_rotation.servo_pprz_cmd" SERVO="WING_ROT"/>
    </command_laws>

    <section NAME="MISC">
        <define VALUE="((3.3f/4096.0f) * 17.9024749557 * adc)" NAME="VoltageOfAdc(adc)"/>
        <define VALUE="TRUE" NAME="NO_RC_THRUST_LIMIT"/>
        <define VALUE="10.0" NAME="ARRIVED_AT_WAYPOINT"/>
        <define VALUE="20" NAME="NO_GPS_LOST_WITH_DATALINK_TIME"/>
        <define VALUE="TRUE" NAME="NO_GPS_LOST_WITH_RC_VALID"/>
        <define VALUE="TRUE" NAME="NO_RC_THRUST_LIMIT"/>
        <define name="GUIDANCE_INDI" value="TRUE"/>
        <define name="AIRFRAME_WITH_PUSHER" value="TRUE"/> 
    </section>

    <section PREFIX="IMU_" NAME="IMU">
        <define VALUE="1" NAME="MPU_CHAN_X"/>
        <define VALUE="0" NAME="MPU_CHAN_Y"/>
        <define VALUE="2" NAME="MPU_CHAN_Z"/>
        <define VALUE="-1" NAME="MPU_X_SIGN"/>
        <define VALUE="1" NAME="MPU_Y_SIGN"/>
        <define VALUE="1" NAME="MPU_Z_SIGN"/>
        <define VALUE="145" NAME="ACCEL_X_NEUTRAL"/>
        <define VALUE="52" NAME="ACCEL_Y_NEUTRAL"/>
        <define VALUE="9" NAME="ACCEL_Z_NEUTRAL"/>
        <define VALUE="4.700654855386415" NAME="ACCEL_X_SENS" INTEGER="16"/>
        <define VALUE="4.898790938271689" NAME="ACCEL_Y_SENS" INTEGER="16"/>
        <define VALUE="4.84846920056402" NAME="ACCEL_Z_SENS" INTEGER="16"/>
        <define name="MAG_X_NEUTRAL" value="12"/>
        <define name="MAG_Y_NEUTRAL" value="1"/>
        <define name="MAG_Z_NEUTRAL" value="-23"/>
        <define name="MAG_X_SENS" value="13.33589802677865" integer="16"/>
        <define name="MAG_Y_SENS" value="11.761077152899478" integer="16"/>
        <define name="MAG_Z_SENS" value="10.648520805398183" integer="16"/>



        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_PHI"/>
        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_THETA"/>
        <define VALUE="0." UNIT="deg" NAME="BODY_TO_IMU_PSI"/>
    </section>

    <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
    <section name="AHRS" prefix="AHRS_">
        <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
        <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
        <define name="GRAVITY_HEURISTIC_FACTOR" value="0"/> 
        <!-- Delft -->
        <define name="H_X" value="0.3892503"/>
        <define name="H_Y" value="0.0017972"/>
        <define name="H_Z" value="0.9211303"/>
    </section>

    <section name="INS" prefix="INS_">
        <define name="USE_GPS_ALT" value="1"/>
        <define name="USE_GPS_ALT_SPEED" value="1"/>
        <define name="VFF_R_GPS" value="0.01"/>
    </section>    

      <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
        <!-- setpoints -->
        <define name="SP_MAX_PHI" value="25" unit="deg"/>
        <define name="SP_MAX_THETA" value="25" unit="deg"/>
        <define name="SP_MAX_R" value="45" unit="deg/s"/>
        <define name="DEADBAND_A" value="2"/>
        <define name="DEADBAND_E" value="2"/>
        <define name="DEADBAND_R" value="50"/>

        <!-- reference -->
        <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
        <define name="REF_ZETA_P" value="0.9"/>
        <define name="REF_MAX_P" value="600." unit="deg/s"/>
        <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
        <define name="REF_ZETA_Q" value="0.9"/>
        <define name="REF_MAX_Q" value="600." unit="deg/s"/>
        <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

        <define name="REF_OMEGA_R" value="200" unit="deg/s"/>
        <define name="REF_ZETA_R" value="0.9"/>
        <define name="REF_MAX_R" value="300." unit="deg/s"/>
        <define name="REF_MAX_RDOT" value="RadOfDeg(4000.)"/>
    </section>

    <section PREFIX="STABILIZATION_INDI_" NAME="STABILIZATION_ATTITUDE_INDI">
        <define name="G1_ROLL"      value="{0.00,   -10.5,   0.00,  10.5,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_PITCH"     value="{2.4,    0.00,   -2.4,   0.00,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_YAW"       value="{0.3, -0.3,  0.3, -0.3, 0.0, 0.0, 0.0, 0.0}"/>
        <define name="G1_THRUST"    value="{-0.34,   -0.34,  -0.34,   -0.34,  0.0, 0.0, 0.0, 0.0}"/>
        <define name="G2"           value="{0.014,  -0.014,   0.014,  -0.014,  0.0, 0.0, 0.0, 0.0}"/>

      <!-- reference acceleration for attitude control -->
        <define name="REF_ERR_P" value="150.0"/>
        <define name="REF_ERR_Q" value="150.0"/>
        <define name="REF_ERR_R" value="85.0"/>
        <define name="REF_RATE_P" value="18.0"/>
        <define name="REF_RATE_Q" value="18.0"/>
        <define name="REF_RATE_R" value="9.7"/>

        <!--Maxium yaw rate, to avoid instability-->
        <define name="MAX_R" value="50.0" unit="deg/s"/>

        <!-- second order filter parameters -->
        <define name="FILT_CUTOFF" value="1.5"/>
        <define name="FILT_CUTOFF_RDOT" value="1.5"/>
        <define name="ESTIMATION_FILT_CUTOFF" value="1.5"/>

        <define name="FILTER_YAW_RATE" value="TRUE"/>

        <!-- first order actuator dynamics -->
        <define name="ACT_DYN" value="{0.047, 0.047, 0.047, 0.047, 0.1, 0.1, 0.1, 0.1}"/>
        <define name="ACT_IS_SERVO" value="{0, 0, 0, 0, 1, 1, 1, 1}"/>

        <define name="WLS_PRIORITIES" value="{500.f, 1000.f, 1.f, 100.f}"/>
        <define name="WLS_WU_MOTOR" value="10"/>

        <define name="WLS_WU_MOTOR_PITCH" value="9.0"/>
        <define name="WLS_WU_MOTOR_ROLL" value="9.0"/>
        <define name="ACT_PREF" value="{0., 0., 0., 0., 0., 0., 0., 0.}"/>

        <!-- Adaptive Learning Rate -->
        <define name="USE_ADAPTIVE" value="TRUE"/>
        <define name="ADAPTIVE_MU" value="0.001"/>
    </section>

    <section name="ROT_WING_EFF_SCHEDULING" prefix="ROT_WING_SCHED_">
        <define name="G1_Q_90" value="{-2.4, 2.4}"/>
        <define name="Y_ARM_LENGTH" value="0.365"/>
        <define name="G1_AERO_CONST_P" value="{0.013, 0.013, 0.0, 0.0}"/> <!--Wing rotation dependency on pitch not scheduled yet-->
        <define name="G1_AERO_CONST_Q" value="{0.0, 0.0, -0.01, 0.0}"/> <!--estimated value, use adaptive for real value-->
        <define name="G1_AERO_CONST_R" value="{0.0, 0.0, 0.0, 0.006}"/> <!--estimated value, use adaptive for real value-->
        <define name="AIRSPEED_FILTER_CUTOFF" value="1.5"/>
        <define name="AERO_EFF_TUNING" value="TRUE"/>
        <!-- float airspeed_q [skew_size] = {0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16};
        float skew_q [skew_size]     = {0,0,0,0,0,0,30,30,30,30,30,30,30,60,70,90,90}; -->
     </section> 

    <section name="FORWARD">
    <!-- This is the pitch angle that the drone will have in forward flight, where 0 degrees is hover-->
        <define name="TRANSITION_MAX_OFFSET" value="0.0" unit="deg"/>
        <define name="GUIDANCE_HEADING_IS_FREE" value="FALSE"/>
    </section>

    <section name="GUIDANCE_INDI_HYBRID" prefix="GUIDANCE_INDI_">
        <define name="POS_GAIN" value="0.8"/><!--tuned at 10m/s ///1.0 1.5-->
        <define name="POS_GAINZ" value="1.5"/> <!--tuned at 10m/s ///1.7 1.0-->
        <define name="SPEED_GAIN" value="0.7"/> <!--tuned at 10m/s ///2.0 1.4-->
        <define name="SPEED_GAINZ" value="1.3"/> <!--tuned at 10m/s ///2.1 2.4-->
        <define name="FILTER_CUTOFF" value="2.0"/>
        <define name="HEADING_BANK_GAIN" value="10."/>
        <define name="NAV_SPEED_MARGIN" value="0."/>
        <define name="MAX_AIRSPEED" value="17."/>
        <define name="PITCH_LIFT_EFF" value="0.0"/>
        <define name="MIN_THROTTLE" value="0."/>
        <define name="MIN_PITCH" value="-35."/>
        <define name="MAX_PITCH" value="35."/>
        <define name="MIN_THROTTLE_FWD" value="0."/>
        <define name="FWD_SIDESLIP_GAIN" value="0.32"/>
        <define name="LINE_GAIN" value="0.005"/>
    </section>

    <section name= "PUSHER">
        <define name="THRUST_BX_EFF" value="0.000851562"/> <!--0.000851562-->
        <define name="THRUST_BX_ACT_DYN" value="0.047"/> <!--0.000851562-->
    </section>

    <section PREFIX="GUIDANCE_V_" NAME="GUIDANCE_V">
        <define VALUE="310" NAME="HOVER_KP"/>
        <define VALUE="130" NAME="HOVER_KD"/>
        <define VALUE="10" NAME="HOVER_KI"/>
        <define VALUE="0.5" NAME="NOMINAL_HOVER_THROTTLE"/>
        <define VALUE="FALSE" NAME="ADAPT_THROTTLE_ENABLED"/>
    </section>

    <section PREFIX="GUIDANCE_H_" NAME="GUIDANCE_H">
        <define VALUE="30" UNIT="deg" NAME="MAX_BANK"/>
        <define VALUE="TRUE" NAME="USE_SPEED_REF"/>
        <define VALUE="60" NAME="PGAIN"/>
        <define VALUE="100" NAME="DGAIN"/>
        <define VALUE="0" NAME="AGAIN"/>
        <define VALUE="20" NAME="IGAIN"/>
        <define VALUE="TRUE" NAME="USE_REF"/>
    </section>

    <section NAME="AUTOPILOT">
        <define VALUE="AP_MODE_ATTITUDE_DIRECT" NAME="MODE_MANUAL"/>
        <define VALUE="AP_MODE_HOVER_Z_HOLD" NAME="MODE_AUTO1"/>
        <define VALUE="AP_MODE_NAV" NAME="MODE_AUTO2"/>
        <define VALUE="AP_MODE_ATTITUDE_DIRECT" NAME="MODE_STARTUP"/>
        <define name="AUTOPILOT_IN_FLIGHT_MIN_THRUST" value="100"/>
    </section>

    <section NAME="GCS">
        <define VALUE="flyingwing" NAME="AC_ICON"/>
        <define VALUE="2" NAME="ALT_SHIFT_PLUS_PLUS"/>
        <define VALUE="1" NAME="ALT_SHIFT_PLUS"/>
        <define VALUE="-1" NAME="ALT_SHIFT_MINUS"/>
    </section>

    <section name="NAVIGATION" prefix="NAV_">
      <define name="CLIMB_VSPEED" value="2.0"/>
      <define name="DESCEND_VSPEED" value="-1.0"/>
    </section>

    <section NAME="BAT">
        <define VALUE="20.0" UNIT="V" NAME="CATASTROPHIC_BAT_LEVEL"/>
        <define VALUE="21.0" UNIT="V" NAME="CRITIC_BAT_LEVEL"/>
        <define VALUE="21.8" UNIT="V" NAME="LOW_BAT_LEVEL"/>
        <define VALUE="25.2" UNIT="V" NAME="MAX_BAT_LEVEL"/>
        <define VALUE="6" NAME="BAT_NB_CELLS"/>
    </section>

    <section name="SIMULATOR" prefix="NPS_">
        <define name="ACTUATOR_NAMES" value="front_motor, right_motor, back_motor, left_motor, ail_left, ail_right, elev, rud, pusher, wing_rotation" type="string[]"/>
        <define name="JSBSIM_MODEL" value="rotating_wing_drone_tomaso" type="string"/>
        <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
        <define name="NO_MOTOR_MIXING" value="TRUE"/>
        <define name="COMMANDS_NB" value="10"/>
    </section>
    
</airframe>
