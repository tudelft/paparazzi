<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="bebop2_optitrack">
  <description>
    Airframe file to fly a Bebop2 drone, in stable smooth flight, through waypoints using an optitrack system, such as the Cyberzoo of TUDelft. The values are tuned so that the flight speed is limited and the drone does not over-shoot the waypoints as it would in outdoor settings.
  </description>

  <firmware name="rotorcraft">
  
    <!-- ****** TARGET AUTOPILOT ****** -->
    <target name="ap" board="bebop2">
      <!-- control effectiveness -->
      <define name="STABILIZATION_INDI_G1_P" value="0.05"/>
      <define name="STABILIZATION_INDI_G1_Q" value="0.025"/>
      <define name="STABILIZATION_INDI_G1_R" value="0.0022"/>
      <define name="STABILIZATION_INDI_G2_R" value="0.20"/>
      
      <!-- SPECIFIC FOR VALKENBURG -->
      <module name="gps" type="ublox">
        <configure name="GPS_BAUD" value="B115200"/>
        <define name="USE_GPS_UBX_RTCM" value="TRUE"/>
        <define name="USE_GPS_UBX_RXM_RAW" value="TRUE"/>
        <configure name="GPS_PORT" value="UART2"/> <!-- always UART2 or UART4 -->
        <define name="INS_VFF_R_GPS" value="0.05"/> 
        <define name="INS_USE_GPS_ALT_SPEED" value="FALSE"/>
        <define name="MISC_ARRIVED_AT_WAYPOINT" value="1.0" unit="m"/>
      </module>
      
      <module name="ahrs" type="int_cmpl_quat">
        <configure name="USE_MAGNETOMETER" value="TRUE"/>
        <define name="AHRS_USE_GPS_HEADING" value="FALSE"/>
      </module>
      
      
      <!-- SPECIFIC FOR OPTI TRACK -->
      <!--<module name="gps" type="datalink"/>
      <define name="INS_VFF_R_GPS" value="0.01"/>
      <define name="INS_USE_GPS_ALT_SPEED" value="TRUE"/>
      <define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
      <define name="MISC_ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/>
      <module name="ahrs" type="int_cmpl_quat">
        <configure name="USE_MAGNETOMETER" value="FALSE"/>
        <define name="AHRS_USE_GPS_HEADING" value="TRUE"/>
      </module>-->
    </target>
    <!-- ****** TARGET AUTOPILOT ****** -->

    <!-- ****** TARGET SIMULATOR ****** -->
    <target name="nps" board="pc">
      <!-- control effectiveness -->
      <define name="STABILIZATION_INDI_G1_P" value="0.0390"/>
      <define name="STABILIZATION_INDI_G1_Q" value="0.0473"/>
      <define name="STABILIZATION_INDI_G1_R" value="0.00122"/> 
      
      <module name="fdm" type="jsbsim"/>
      <module name="udp"/>
      <define name="STABILIZATION_INDI_G2_R" value="0.0"/><!-- for jsbsim (rotor inertia is not modelled) -->
      
      <!-- SPECIFIC FOR SIM -->
      <module name="gps" type="datalink"/>
      <define name="INS_VFF_R_GPS" value="0.01"/> <!-- 0.01 for optitrack ELSE 0.1 -->
      <define name="INS_USE_GPS_ALT_SPEED" value="TRUE"/> <!-- TRUE for optitrack -->
      <define name="AHRS_HEADING_UPDATE_GPS_MIN_SPEED" value="0"/> <!-- only for optitrack -->
      <define name="MISC_ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/> <!-- small value for optitrack, else around 1 to 3 meters -->
      <module name="ahrs" type="int_cmpl_quat">
        <configure name="USE_MAGNETOMETER" value="TRUE"/>
        <define name="AHRS_USE_GPS_HEADING" value="FALSE"/>
      </module>
    </target>
    <!-- ****** TARGET SIMULATOR ****** -->
    
    <!--define name="USE_SONAR" value="FALSE"/-->
    <module name="sonar_bebop">
      <define name="USE_SONAR"/>
      <define name="SENSOR_SYNC_SEND_SONAR"/>
    </module>

    <!-- Subsystem section -->
    <module name="telemetry" type="transparent_udp"/>
    <module name="radio_control" type="datalink"/>
    <module name="motor_mixing"/>
    <module name="actuators" type="bebop"/>
    <module name="imu" type="bebop"/>
    <module name="guidance" type="indi">
      <define name="GUIDANCE_INDI_POS_GAIN" value="1.0"/>
      <define name="GUIDANCE_INDI_SPEED_GAIN" value="1.0"/>
      <!--define name="GUIDANCE_INDI_THRUST_DYNAMICS" value="0.06"/-->
      <define name="GUIDANCE_INDI_FILTER_CUTOFF" value="1.0"/> <!-- 1 works well, 3 makes it wobbling -->
    </module>
    
    <module name="stabilization" type="indi_simple"/>
    <module name="ins" type="extended"/>
    <module name="geo_mag"/>
    <module name="air_data"/>
    
    <!-- special for project Andreas -->
    <module name="approach_moving_target"/><!-- added by andreas 22-09-2022 -->
      <define name="AMT_ERR_SLOWDOWN_GAIN" value="true"/><!-- added by andreas 22-09-2022 -->
     <!-- Logging fligth data to internal storage (NOT TESTED YET) -->
    <module name="logger_file">
      <define name="FILE_LOGGER_PATH" value="/data/ftp/internal_000/log"/>
    </module>
  </firmware>
  
  <commands>
    <axis name="PITCH" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="0"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="6000"/>
  </commands>

  <servos driver="Default">
    <servo name="TOP_LEFT" no="0" min="2500" neutral="2500" max="12000"/>
    <servo name="TOP_RIGHT" no="1" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_RIGHT" no="2" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_LEFT" no="3" min="2500" neutral="2500" max="12000"/>
  </servos>

  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    <define name="REVERSE" value="TRUE"/>
    <define name="TYPE" value="QUAD_X"/>
  </section>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
    <set servo="TOP_LEFT" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
    <set servo="TOP_RIGHT" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
    <set servo="BOTTOM_RIGHT" value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
    <set servo="BOTTOM_LEFT" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
  </command_laws>

  <section name="AIR_DATA" prefix="AIR_DATA_">
    <define name="CALC_AIRSPEED" value="FALSE"/>
    <define name="CALC_TAS_FACTOR" value="FALSE"/>
    <define name="CALC_AMSL_BARO" value="TRUE"/>
  </section>

  <section name="IMU" prefix="IMU_">
    <!-- Magneto calibration -->
    <define name="MAG_X_NEUTRAL" value="-16"/>
    <define name="MAG_Y_NEUTRAL" value="55"/>
    <define name="MAG_Z_NEUTRAL" value="204"/>
    <define name="MAG_X_SENS" value="7.28514789391" integer="16"/>
    <define name="MAG_Y_SENS" value="7.33022132691" integer="16"/>
    <define name="MAG_Z_SENS" value="7.57102035692" integer="16"/>
  </section>
  
  <!--<include href="conf/airframes/ShipLanding/calibrations/bb2_imu_accel_bebopErik.xml"/>--> <!-- Accelerometer for attitude -->
  
  <!-- local magnetic field -->
  <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <!-- Toulouse -->
    <!--define name="H_X" value="0.513081"/>
    <define name="H_Y" value="-0.00242783"/>
    <define name="H_Z" value="0.858336"/-->
    <!-- Delft -->
    <define name="H_X" value="0.3892503"/>
    <define name="H_Y" value="0.0017972"/>
    <define name="H_Z" value="0.9211303"/>
    <define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/>
  </section>

  <section name="INS" prefix="INS_">
    <define name="SONAR_MAX_RANGE" value="2.2"/>
    <define name="SONAR_MIN_RANGE" value="0.2"/>
    <define name="USE_GPS_ALT" value="TRUE"/>
    <!--define name="USE_GPS_ALT_SPEED" value="TRUE"/-->
    <!--define name="VFF_R_GPS" value="0.01"/--> <!-- 0.01 for optitrack ELSE 0.1 -->
  </section>


  <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoint limits for attitude stabilization rc flight -->
    <define name="SP_MAX_PHI" value="45" unit="deg"/>
    <define name="SP_MAX_THETA" value="45" unit="deg"/>
    <define name="SP_MAX_R" value="300" unit="deg/s"/>
    <define name="DEADBAND_A" value="0"/>
    <define name="DEADBAND_E" value="0"/>
    <define name="DEADBAND_R" value="50"/>
  </section>

  <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <!-- attitude reference generation model -->
    <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.9"/>
    <define name="REF_MAX_P" value="600." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.9"/>
    <define name="REF_MAX_Q" value="600." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_R" value="450" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.9"/>
    <define name="REF_MAX_R" value="600." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(8000.)"/>
  </section>

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness 
    <define name="G1_P" value="0.05"/>
    <define name="G1_Q" value="0.025"/>
    <define name="G1_R" value="0.0022"/>
    <define name="G2_R" value="0.20"/>-->

    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="170.0"/>
    <define name="REF_ERR_Q" value="600.0"/>
    <define name="REF_ERR_R" value="600.0"/>
    <define name="REF_RATE_P" value="14.3"/>
    <define name="REF_RATE_Q" value="28.0"/>
    <define name="REF_RATE_R" value="28.0"/>

    <!-- second order filter parameters -->
    <define name="FILT_CUTOFF" value="3.2"/>
    <define name="FILT_CUTOFF_RDOT" value="3.2"/>

    <!-- first order actuator dynamics -->
    <define name="ACT_DYN_P" value="0.06"/>
    <define name="ACT_DYN_Q" value="0.06"/>
    <define name="ACT_DYN_R" value="0.06"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="350"/>
    <define name="HOVER_KD" value="85"/>
    <define name="HOVER_KI" value="20"/>
    <define name="NOMINAL_HOVER_THROTTLE" value="0.56"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="TRUE"/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <!-- Good weather -->
    <define name="MAX_BANK" value="20" unit="deg"/>
    <define name="REF_MAX_SPEED" value="3.0" unit="m/s"/>
    <!-- Bad weather -->
    <!-- define name="MAX_BANK" value="32" unit="deg"/ -->
    <define name="PGAIN" value="120"/>
    <define name="DGAIN" value="100"/>
    <define name="IGAIN" value="30"/>
    <define name="REF_ZETA" value="1.0"/> <!-- 1.0 or more for no overshooting -->
  </section>

  <section name="MISC">
    <!--define name="ARRIVED_AT_WAYPOINT" value="0.2" unit="m"/--> <!-- how far away it declares that the waypoint is reached -->
  </section>

  <section name="IMU" prefix="IMU_">
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="0." unit="deg"/>
  </section>

  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="0.5"/>
    <define name="DESCEND_VSPEED" value="-1.0"/>
  </section>
  
  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="nw_motor, ne_motor, se_motor, sw_motor" type="string[]"/>
    <define name="JSBSIM_MODEL" value="simple_x_quad" type="string"/>
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
  </section>
  <include href="conf/simulator/gazebo/airframes/bebop.xml"/>

  <section name="AUTOPILOT">
    <define name="MODE_STARTUP" value="AP_MODE_NAV"/>
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_Z_HOLD"/>
    <define name="MODE_AUTO2" value="AP_MODE_NAV"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
  </section>
  
  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="11000"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.5" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="10.0" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="10.5" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="12.4" unit="V"/>
    <define name="BAT_CHECKER_DELAY" value="60"/><!-- unit="s/10", thus tenth of seconds per default use ELECTRICAL_PERIODIC_FREQ if you for some reason want it differently-->
  </section>
  
  

  <section name="GCS">
    <define name="AC_ICON"             value="quadrotor_xi"/>
  </section>
</airframe>
