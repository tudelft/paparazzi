<!DOCTYPE airframe SYSTEM "../airframe.dtd">

<airframe name="bebop2_Valkenburg">
  <description>
    Airframe file to fly a Bebop2 drone, in stable smooth flight, through waypoints using an optitrack system, such as the Cyberzoo of TUDelft. The values are tuned so that the flight speed is limited and the drone does not over-shoot the waypoints as it would in outdoor settings.
  </description>

  <firmware name="rotorcraft">
    <target name="ap" board="bebop2">
    	<!--define name="PRINT_DEBUG_GPS_UBX_UCENTER" value="TRUE"/-->
    </target>

    <target name="nps" board="pc">
      <module name="fdm" type="jsbsim"/>
      <module name="udp"/>
    </target>
    
    <define name="USE_SONAR" value="FALSE"/>
    <configure name="USE_BARO_BOARD" value="TRUE"/>

    <!-- Subsystem section -->
    <module name="telemetry" type="transparent_udp"/>
    <module name="radio_control" type="datalink"/>
    <module name="motor_mixing"/>
    <module name="actuators" type="bebop"/>
    <module name="imu" type="bebop"/>
    
    <!-- GPS settings for optitrack 
    <module name="gps" type="datalink"/>-->
    
    <!-- GPS settings for normal internal gps 
    <module name="gps" type="ublox"/>
    <module name="gps" type="ubx_ucenter"/> -->
    
    <!-- GPS settings for bepop2 with "ZED-F9P RTK" gps via Xbee usb serial board HX-186-->
    <module name="gps" type="ublox">
      <!--configure name="GPS_BAUD" value="B57600"/-->
      <configure name="GPS_BAUD" value="B115200"/>
      <define name="USE_GPS_UBX_RTCM" value="TRUE"/>
      <define name="USE_GPS_UBX_RXM_RAW" value="TRUE"/>
      <configure name="GPS_PORT" value="UART2"/> <!-- always UART2 or UART4 -->
    </module>
    <!--module name="gps" type="ubx_ucenter"/-->
    
    <module name="stabilization" type="indi_simple"/>
    <module name="air_data">
     <define name="CALC_AIRSPEED" value="FALSE"/>
     <define name="CALC_TAS_FACTOR" value="FALSE"/>
     <define name="CALC_AMSL_BARO" value="TRUE"/>
  </module>
    <module name="ahrs" type="int_cmpl_quat">
      <configure name="USE_MAGNETOMETER" value="TRUE"/> <!-- FALSE for optitrack -->
      <define name="AHRS_USE_GPS_HEADING" value="FALSE"/> <!-- TRUE for optitrack -->
      <define name="AHRS_USE_SONAR" value="TRUE"/> <!-- added for testing -->
    </module>
    <module name="ins" type="extended"/>
    <module name="geo_mag"/>
    <!--module name="send_imu_mag_current"/-->
    <module name="approach_moving_target"/><!-- added by andreas 22-09-2022 -->
      <define name="AMT_ERR_SLOWDOWN_GAIN" value="true"/><!-- added by andreas 22-09-2022 -->
    <module name="sys_mon"/>
    <module name="imu_temp_ctrl">
      <define name="IMU_TEMP_CTRL_DEBUG"/>
    </module>
    <!-- can be used in flightplan during takeoff/landing or lowflyby with default sonar -->
    <module name="agl_dist">
        <!-- Make sure something like this is defined -->
        <define name="USE_SONAR" value="FALSE"/> 
    </module>
  </firmware>
  
  <commands>
    <axis name="PITCH" failsafe_value="0"/>
    <axis name="ROLL" failsafe_value="0"/>
    <axis name="YAW" failsafe_value="0"/>
    <axis name="THRUST" failsafe_value="6000"/>
  </commands>

  <servos driver="Default">
    <servo name="TOP_LEFT" no="0" min="2500" neutral="2500" max="12000"/>
    <servo name="TOP_RIGHT" no="1" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_RIGHT" no="2" min="2500" neutral="2500" max="12000"/>
    <servo name="BOTTOM_LEFT" no="3" min="2500" neutral="2500" max="12000"/>
  </servos>

  <section name="MIXING" prefix="MOTOR_MIXING_">
    <define name="TRIM_ROLL" value="0"/>
    <define name="TRIM_PITCH" value="0"/>
    <define name="TRIM_YAW" value="0"/>
    <define name="REVERSE" value="TRUE"/>
    <define name="TYPE" value="QUAD_X"/>
  </section>

  <command_laws>
    <call fun="motor_mixing_run(autopilot_get_motors_on(),FALSE,values)"/>
    <set servo="TOP_LEFT" value="motor_mixing.commands[MOTOR_FRONT_LEFT]"/>
    <set servo="TOP_RIGHT" value="motor_mixing.commands[MOTOR_FRONT_RIGHT]"/>
    <set servo="BOTTOM_RIGHT" value="motor_mixing.commands[MOTOR_BACK_RIGHT]"/>
    <set servo="BOTTOM_LEFT" value="motor_mixing.commands[MOTOR_BACK_LEFT]"/>
  </command_laws>

  <section name="IMU" prefix="IMU_">
    <!-- Magneto calibration -->
    <define name="MAG_X_NEUTRAL" value="-48"/>
    <define name="MAG_Y_NEUTRAL" value="-3"/>
    <define name="MAG_Z_NEUTRAL" value="216"/>
    <define name="MAG_X_SENS" value="7.068482272360146" integer="16"/>
    <define name="MAG_Y_SENS" value="7.132353004570351" integer="16"/>
    <define name="MAG_Z_SENS" value="7.386998321197417" integer="16"/>
  </section>
  
  <section name="IMU" prefix="IMU_">
    <!-- Accelerometer calibration -->
    <define name="ACCEL_X_NEUTRAL" value="21"/>
    <define name="ACCEL_Y_NEUTRAL" value="-13"/>
    <define name="ACCEL_Z_NEUTRAL" value="-121"/>
    <define name="ACCEL_X_SENS" value="2.4424887250032836" integer="16"/>
    <define name="ACCEL_Y_SENS" value="2.4261614464896293" integer="16"/>
    <define name="ACCEL_Z_SENS" value="2.4443616138224944" integer="16"/>
  </section>
  
  <!-- local magnetic field -->
  <!-- http://wiki.paparazziuav.org/wiki/Subsystem/ahrs#Local_Magnetic_Field -->
  <section name="AHRS" prefix="AHRS_">
    <!-- values used if no GPS fix, on 3D fix is update by geo_mag module -->
    <!-- Toulouse -->
    <!--define name="H_X" value="0.513081"/>
    <define name="H_Y" value="-0.00242783"/>
    <define name="H_Z" value="0.858336"/-->
    <!-- Delft -->
    <define name="H_X" value="0.3892503"/>
    <define name="H_Y" value="0.0017972"/>
    <define name="H_Z" value="0.9211303"/>
    <!--define name="HEADING_UPDATE_GPS_MIN_SPEED" value="0"/--> <!-- only for optitrack -->
  </section>
  
  <!-- *************************** SONAR DEVICE ***************************** -->
  <section name="SONAR" prefix="SONAR_">
    <define name="SCALE" value="0.016775" integer="16"/>
    <define name="OFFSET" value="0.03" unit="m"/><!-- The landing gear height to tarmac in respect to sonar bottom -->
    <define name="MAX_RANGE" value="9.0" unit="m"/>
    <define name="MIN_RANGE" value="0.18" unit="m"/>
  </section>

  <!-- *************************** AGL **************************** -->
  <section name="AGL" prefix="AGL_DIST_SONAR_">
    <define name="ID" value="ABI_BROADCAST"/>
    <define name="MAX_RANGE" value="7.0" unit="m"/> <!-- used upto 7.0m-->
    <define name="MIN_RANGE" value="0.020" unit="m"/> <!-- use downto 0.2m -->
    <define name="FILTER" value="0.15"/> <!--Low pass filter time constant-->
  </section>

  <section name="INS" prefix="INS_">
    <define name="SONAR_MAX_RANGE" value="2.2"/>
    <define name="SONAR_MIN_RANGE" value="0.2"/>
    <define name="USE_GPS_ALT" value="TRUE"/>
    <define name="USE_GPS_ALT_SPEED" value="FALSE"/> <!-- TRUE for optitrack -->
    <define name="VFF_R_GPS" value="0.075"/> <!-- optitrack 0.01 ELSE 0.1 -->
    
    <!-- If you trust GPS a lot use this: -->
    <!-- <define name="VFF_R_GPS" value="0.01"/> -->
    <!-- <define name="VFF_VZ_R_GPS" value="0.01"/> -->

    <!-- trust more the baro over the gps alt -->
    <define name="INV_NXZ" value="0.3"/>
    <define name="INV_NH" value="2.0"/>
  </section>


  <section name="RC_SETPOINT" prefix="STABILIZATION_ATTITUDE_">
    <!-- setpoint limits for attitude stabilization rc flight -->
    <define name="SP_MAX_PHI" value="45" unit="deg"/>
    <define name="SP_MAX_THETA" value="45" unit="deg"/>
    <define name="SP_MAX_R" value="300" unit="deg/s"/>
    <define name="DEADBAND_A" value="0"/>
    <define name="DEADBAND_E" value="0"/>
    <define name="DEADBAND_R" value="50"/>
  </section>

  <section name="ATTITUDE_REFERENCE" prefix="STABILIZATION_ATTITUDE_">
    <!-- attitude reference generation model -->
    <define name="REF_OMEGA_P" value="450" unit="deg/s"/>
    <define name="REF_ZETA_P" value="0.9"/>
    <define name="REF_MAX_P" value="600." unit="deg/s"/>
    <define name="REF_MAX_PDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_Q" value="450" unit="deg/s"/>
    <define name="REF_ZETA_Q" value="0.9"/>
    <define name="REF_MAX_Q" value="600." unit="deg/s"/>
    <define name="REF_MAX_QDOT" value="RadOfDeg(8000.)"/>

    <define name="REF_OMEGA_R" value="450" unit="deg/s"/>
    <define name="REF_ZETA_R" value="0.9"/>
    <define name="REF_MAX_R" value="600." unit="deg/s"/>
    <define name="REF_MAX_RDOT" value="RadOfDeg(8000.)"/>
  </section>

  <section name="STABILIZATION_ATTITUDE_INDI" prefix="STABILIZATION_INDI_">
    <!-- control effectiveness -->
    <define name="G1_P" value="0.05"/>
    <define name="G1_Q" value="0.025"/>
    <define name="G1_R" value="0.0022"/>
    <define name="G2_R" value="0.20"/>
    
    <!-- parameters I want to test
    <define name="G1_P" value="0.0390"/>
    <define name="G1_Q" value="0.0473"/>
    <define name="G1_R" value="0.00122"/> -->

    <!-- reference acceleration for attitude control -->
    <define name="REF_ERR_P" value="170.0"/>
    <define name="REF_ERR_Q" value="600.0"/>
    <define name="REF_ERR_R" value="600.0"/>
    <define name="REF_RATE_P" value="14.3"/>
    <define name="REF_RATE_Q" value="28.0"/>
    <define name="REF_RATE_R" value="28.0"/>

    <!-- second order filter parameters -->
    <define name="FILT_CUTOFF" value="3.2"/>
    <define name="FILT_CUTOFF_RDOT" value="3.2"/>

    <!-- first order actuator dynamics -->
    <define name="ACT_DYN_P" value="0.06"/>
    <define name="ACT_DYN_Q" value="0.06"/>
    <define name="ACT_DYN_R" value="0.06"/>

    <!-- Adaptive Learning Rate -->
    <define name="USE_ADAPTIVE" value="FALSE"/>
    <define name="ADAPTIVE_MU" value="0.0001"/>
  </section>

  <section name="GUIDANCE_V" prefix="GUIDANCE_V_">
    <define name="HOVER_KP" value="350"/>
    <define name="HOVER_KD" value="85"/>
    <define name="HOVER_KI" value="20"/>
    <define name="NOMINAL_HOVER_THROTTLE" value="0.56"/>
    <define name="ADAPT_THROTTLE_ENABLED" value="TRUE"/>
  </section>

  <section name="GUIDANCE_H" prefix="GUIDANCE_H_">
    <!-- Good weather -->
    <define name="MAX_BANK" value="20" unit="deg"/>
    <define name="REF_MAX_SPEED" value="1.0" unit="m/s"/>
    <!-- Bad weather -->
    <!-- define name="MAX_BANK" value="32" unit="deg"/ -->
    <define name="PGAIN" value="120"/>
    <define name="DGAIN" value="100"/>
    <define name="IGAIN" value="30"/>
    <define name="REF_ZETA" value="1.0"/> <!-- 1.0 or more for no overshooting -->
  </section>

  <section name="MISC">
    <define name="ARRIVED_AT_WAYPOINT" value="1.0" unit="m"/> <!-- how far away it declares that the waypoint is reached --> <!-- small value for optitrack -->
  </section> 

  <section name="IMU" prefix="IMU_">
    <define name="BODY_TO_IMU_PHI" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_THETA" value="0." unit="deg"/>
    <define name="BODY_TO_IMU_PSI" value="0." unit="deg"/>
  </section>

  <section name="NAVIGATION" prefix="NAV_">
    <define name="CLIMB_VSPEED" value="1.0"/>
    <define name="DESCEND_VSPEED" value="-1.0"/>
  </section>

  <section name="SIMULATOR" prefix="NPS_">
    <define name="ACTUATOR_NAMES" value="nw_motor, ne_motor, se_motor, sw_motor" type="string[]"/>
    <define name="JSBSIM_MODEL" value="simple_x_quad_ccw" type="string"/>
    <define name="SENSORS_PARAMS" value="nps_sensors_params_default.h" type="string"/>
  </section>

  <section name="AUTOPILOT">
    <!-- 
    AP_MODE_HOVER_DIRECT:  hold horizontal position, vertical is dependend on throttle joystick
    AP_MODE_ATTITUDE_Z_HOLD: Altitude fixed, only moving in horizontal plane with joystick
    AP_MODE_ATTITUDE_RC_CLIMB: Altitude stable with joytstick throttle at 50%, horizontal normal as with joystick ATT
    AP_MODE_GUIDED: NOT SURE, has something to do with placing the carrot somewhere and the drone will follow
    -->
    <define name="MODE_STARTUP" value="AP_MODE_NAV"/>
    <define name="MODE_MANUAL" value="AP_MODE_ATTITUDE_DIRECT"/>
    <define name="MODE_AUTO1" value="AP_MODE_ATTITUDE_Z_HOLD"/>
    <define name="MODE_AUTO2" value="AP_MODE_NAV"/>
    <define name="NO_RC_THRUST_LIMIT" value="TRUE"/>
  </section>

  <section name="BAT">
    <define name="MILLIAMP_AT_FULL_THROTTLE" value="11000"/>
    <define name="CATASTROPHIC_BAT_LEVEL" value="9.9" unit="V"/>
    <define name="CRITIC_BAT_LEVEL" value="11.0" unit="V"/>
    <define name="LOW_BAT_LEVEL" value="11.1" unit="V"/>
    <define name="MAX_BAT_LEVEL" value="12.4" unit="V"/>
  </section>
  
  <section name="GCS">
    <define name="AC_ICON"             value="quadrotor_xi"/>
  </section>
</airframe>
