<?xml version="1.0"?>
<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<flight_plan SECURITY_HEIGHT="2" NAME="PN Valkenburg" MAX_DIST_FROM_HOME="5000" LON0="4.412444" LAT0="52.168595" GROUND_ALT="0" ALT="8.0">
  <header>
    #include "modules/datalink/datalink.h"
    #include "modules/energy/electrical.h"
    #include "modules/radio_control/radio_control.h"
    #include "modules/ahrs/ahrs.h"
    #include "modules/pn/pn.h"
    #include "modules/loggers/logger_file.h"
    #define NPS_GAZEBO_WORLD "cyberzoo_orange_poles.world"
</header>
<waypoints>
    <waypoint NAME="HOME" LON="4.4134865" LAT="52.1682196"/>
    <waypoint Y="-80.4" X="62.6" NAME="CLIMB"/>
    <waypoint Y="-55.1" X="106.0" NAME="STDBY"/>
    <waypoint LON="4.4124439" LAT="52.1685949" NAME="p1_I"/>
    <waypoint Y="-148.1" X="696.0" NAME="p2"/>
    <waypoint Y="73.4" X="600.4" NAME="p3"/>
    <waypoint Y="-48.5" X="238.6" NAME="p4"/>
    <waypoint Y="-23.7" X="-4.1" NAME="TD"/>
    <waypoint Y="-87.8" X="123.2" NAME="FOLLOW"/>
    <waypoint NAME="PS" LON="4.4174372" LAT="52.1669450"/>
    <waypoint NAME="S2" LON="4.4208804" LAT="52.1689871"/>
    <waypoint NAME="C1" LON="4.410820" LAT="52.169189"/>
    <waypoint NAME="C2" LON="4.406923" LAT="52.168049"/>
    <waypoint NAME="C3" LON="4.408235" LAT="52.166515"/>
    <waypoint NAME="C4" LON="4.407668" LAT="52.163255"/>
    <waypoint NAME="C5" LON="4.410082" LAT="52.161908"/>
    <waypoint NAME="C6" LON="4.416992" LAT="52.162641"/>
    <waypoint NAME="C7" LON="4.427268" LAT="52.164861"/>
    <waypoint NAME="C8" LON="4.427511" LAT="52.170422"/>
    <waypoint NAME="C9" LON="4.424011" LAT="52.172276"/>
    <waypoint NAME="p5" LON="4.4127541" LAT="52.1673931"/>
    <waypoint NAME="p6" LON="4.4150577" LAT="52.1678569"/>
    <waypoint NAME="p7" LON="4.4144979" LAT="52.1689993"/>
    <waypoint NAME="p8" LON="4.4121999" LAT="52.1686045"/>
</waypoints>
<sectors>
    <sector NAME="Hard_Geofence" COLOR="red">
        <corner NAME="C1"/>
        <corner NAME="C2"/>
        <corner NAME="C3"/>
        <corner NAME="C4"/>
        <corner NAME="C5"/>
        <corner NAME="C6"/>
        <corner NAME="C7"/>
        <corner NAME="C8"/>
        <corner NAME="C9"/>
    </sector>
</sectors>
  <variables>
    <variable var="intercept" init="true" type="bool"/>
  </variables>
  <modules>
  	<module name="pn"/>
  </modules>
  <exceptions>
    <!-- RC lost -->
    <!--exception cond="((radio_control.status == RC_REALLY_LOST) @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="Standby"/-->
    <!-- Datalink lost (constant RPM descent) -->
    <exception cond="((datalink_time @GT 5) @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="land here"/>
    <!-- Geofencing XY -->
    <exception cond="(!InsideHard_Geofence(GetPosX(), GetPosY()) @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="land here"/>
    <!-- Geofencing Z 3.5 -->
    <!--exception cond="((GetPosAlt() @GT 3.5) @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="land here"/-->
    <!-- Geofencing Z 4.5 (constant RPM descent)-->
    <exception cond="((GetPosAlt() @GT 100.0) @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      (autopilot_in_flight() == true) )" deroute="Landed"/>
    <!-- Bat low -->
    <exception cond="(electrical.bat_low @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="land here"/>
    <!-- Bat critical (constant RPM no stabilization)-->
    <exception cond="(electrical.bat_critical @AND
      !(IndexOfBlock('Holding point') @GT nav_block) @AND
      !(nav_block >= IndexOfBlock('land here')) @AND
      (autopilot_in_flight() == true) )" deroute="land here"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <call_once fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid()"/>
    </block>
    <block name="Geo init">
      <while cond="LessThan(NavBlockTime(), 2)"/>
      <call_once fun="NavSetAltitudeReferenceHere()"/>
    </block>
    <block name="Holding point">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    <block key="r" name="Start Engine">
      <call_once fun="NavResurrect()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
      <call_once fun="NavResurrect()"/>
    </block>
    <block key="t" name="Takeoff" strip_button="Takeoff" strip_icon="takeoff.png">
      <exception cond="GetPosAlt() @GT 0.8" deroute="Standby"/>
      <call_once fun="NavSetWaypointHere(WP_CLIMB)"/>
      <stay climb="nav.climb_vspeed" vmode="climb" wp="CLIMB"/>
    </block>
    <block key="s" name="Standby" strip_button="Standby" strip_icon="home.png">
      <call_once fun="NavSetWaypointHere(WP_STDBY)"/>
      <stay wp="STDBY"/>
    </block>
    <block key="g" name="START" strip_button="Go" strip_icon="lookfore.png">
      <!-- <call_once fun="logger_file_start()"/> -->
      <call_once fun="pn_start()"/>
      <exception cond="!intercept" deroute="STOP"/>
      <while>
        <call fun="pn_run"/>
      </while>
    </block>
    <block name="STOP">
      <!-- <call_once fun="logger_file_stop()"/> -->
      <call_once fun="pn_stop()"/> 
      <stay wp="STDBY"/>
    </block>
    <block name="Stand">
      <stay wp="PS"/>
    </block>
    <block key="l" name="land here" strip_button="land here" strip_icon="land-right.png">
      <call_once fun="NavSetWaypointHere(WP_TD)"/>
      <go wp="TD"/>
      <deroute block="Flare"/>
    </block>
    <block name="Land">
      <go wp="TD"/>
      <deroute block="Flare"/>
    </block>
    <block name="Flare">
      <!-- <exception cond="NavDetectGround()" deroute="Holding point"/> -->
      <exception cond="!nav_is_in_flight()" deroute="Landed"/>
      <!-- <exception cond="0.10 @GT GetPosAlt()" deroute="Landed"/> -->
      <!-- <call_once fun="NavStartDetectGround()"/> -->
      <stay climb="nav.descend_vspeed" vmode="climb" wp="TD"/>
    </block>
    <block name="Landed">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
  </blocks>
</flight_plan>
