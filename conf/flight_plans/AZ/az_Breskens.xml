<!DOCTYPE flight_plan SYSTEM "../flight_plan.dtd">

<!-- In this flightplan:
Exceptions:
- Battery critical, return home, hover at 2m
- Geo-fencing yellow, return to home
- Geo-fencing red, kill drone
- connection lost for 30sec, hover 60sec, return home 60sec, descent to 2m 60sec, land
- TODO joystick timeout

Blocks:
- Wait GPS
- Geo Init
- Holding point hover
- Start engine
- Takeoff
- HoverHeigthShip
- HoverHeigthApproach
- route
- standby
- GoTo Approach point
- GoTo ship
- Approach SHIP
- reset_distance_descent
- set_landing_offset_here
- stay p1
- go p2
- line_p1_p2
- land here
- flare
- landed
- autodescent 40perc throttle TEST
- autodescent 30perc throttle TEST
- autodescent 20perc throttle TEST
- Emergency battery critical
- Emergency connection lost Hover
- Emergency connection lost Home
- Emergency connection lost Descent
- Holding point kill

... Headings ...
heading 70 degree (facing from the concrete into the field):
- holding point hover
- hover heigth ship
- hover height approach
- goto/stay at approach position
- goto/stay at ship position
- land here
- flare
- autodecent 40/30/20 % throttle
- battery critical
- datalink lost
- standby

heading towards waypoint:
- route
- approach ship

heading not defined at:
- start engine
- takeoff
- wait gps
- geo init
- reset_distance_descent
- set_landing_offset_here_TEST
- landed
- holding point kill

-->
<!--flight_plan alt="2" ground_alt="0" lat0="51.990634" lon0="4.376789" max_dist_from_home="200" name="Rotorcraft Cyberzoo (Delft) no GPS" security_height="0.3"-->
<!--flight_plan alt="5" ground_alt="0" lat0="52.1681455" lon0="4.4128056" max_dist_from_home="250" name="Nederdrone Valkenburg" security_height="5"-->
<flight_plan alt="5" ground_alt="0" lat0="51.39951" lon0="3.54657" max_dist_from_home="100" name="Bebop Test Breskens Ferry" security_height="5">
  <header>
    #include "autopilot.h"
    #include "modules/datalink/datalink.h"
    #include "modules/ctrl/approach_moving_target.h"
    #include "modules/ctrl/target_pos.h"
    #include "modules/energy/electrical.h"
</header>
  <waypoints>
    <waypoint x="0"           y="0"          name="HOME"/>
    <waypoint x="0"           y="0"          name="STDBY"/>
    <waypoint x="10"          y="10"         name="p1"/>
    <waypoint x="-10"         y="10"         name="p2"/>
    <waypoint x="-10"         y="-10"        name="p3"/>
    <waypoint x="10"          y="-10"        name="p4"/>
    <waypoint name="_landHere"   x="5"   y="5"/>
    <waypoint name="SHIP"        x="-5"  y="-5"/>
    <waypoint name="APPROACH"    x="-15" y="-15"/>
    <waypoint name="_StayHover"  x="0"   y="0"/>
    <waypoint name="_Takeoff"    x="0"   y="0"/>
    <waypoint lat="51.397873" lon="3.548559" name="_BreskensFerry1"/>
    <waypoint lat="51.397942" lon="3.544810" name="_BreskensFerry2"/>
    <waypoint lat="51.401470" lon="3.545030" name="_BreskensFerry3"/>
    <waypoint lat="51.400403" lon="3.549402" name="_BreskensFerry4"/>
  </waypoints>
  <sectors>
    <sector color="red" name="SafeFlyZone">
      <corner name="_BreskensFerry1"/>
      <corner name="_BreskensFerry2"/>
      <corner name="_BreskensFerry3"/>
      <corner name="_BreskensFerry4"/>
    </sector>
  </sectors>
  <modules/>
  <exceptions>
    <!-- Execute emergency protocol when battery voltage is critically low -->
    <exception cond="electrical.bat_critical 
    @AND !(nav_block == IndexOfBlock('Wait GPS')) 
    @AND !(nav_block == IndexOfBlock('Geo init')) 
    @AND !(nav_block == IndexOfBlock('Holding point kill')) 
    @AND !(nav_block == IndexOfBlock('Land Here')) 
    @AND !(nav_block == IndexOfBlock('flare')) 
    @AND !(nav_block == IndexOfBlock('landed')) 
    @AND !(nav_block == IndexOfBlock('Emergency battery critical'))" 
    deroute="Emergency battery critical"/>

    <!-- Execute emergency protocol when datalink is lost for more than 5sec -->
    <exception cond="autopilot_in_flight() @AND datalink_time @GT 5 
    @AND !(nav_block == IndexOfBlock('Wait GPS')) 
    @AND !(nav_block == IndexOfBlock('Geo init')) 
    @AND !(nav_block == IndexOfBlock('Holding point kill')) 
    @AND !(nav_block == IndexOfBlock('Land Here')) 
    @AND !(nav_block == IndexOfBlock('Emergency battery critical'))" 
    deroute="Emergency connection lost Hover"/>

    <!-- Breskens: hover when touching flyzone geofence OR altitude above 60m -->
    <exception cond="Or(! InsideSafeFlyZone(GetPosX(), GetPosY()), GetPosAlt() @GT GetAltRef() + 100)
    @AND !(nav_block == IndexOfBlock('Wait GPS')) 
    @AND !(nav_block == IndexOfBlock('Geo init')) 
    @AND !(nav_block == IndexOfBlock('autodescent 53perc throttle TEST')) 
    @AND !(nav_block == IndexOfBlock('HOME'))
    @AND !(nav_block == IndexOfBlock('Land Here'))"
    deroute="Holding point kill"/>

    <!-- Goto "hover" when in "connection lost" and signal is restored -->
    <exception cond="Or(Or((nav_block == IndexOfBlock('Emergency connection lost Hover')), 
    (nav_block == IndexOfBlock('Emergency connection lost Home'))), 
    (nav_block == IndexOfBlock('Emergency connection lost Descent'))) 
    @AND datalink_time @LT 10 " 
    deroute="Holding point hover"/>
  </exceptions>
  <blocks>
    <block name="Wait GPS">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavKillThrottle()"/>
      <while cond="!GpsFixValid() || !state.ned_initialized_i"/>
      <call_once fun="init_wp_ids(WP_SHIP, WP_APPROACH)"/>
      <call_once fun="approach_moving_target_enable()"/>
      <deroute block="Geo init"/>
    </block>
    
    <block name="Geo init">
      <set value="FALSE" var="force_forward"/>
      <while cond="LessThan(NavBlockTime(), 10)"/>
      <call_once fun="NavSetAltitudeReferenceHere()"/>
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <deroute block="Holding point kill"/>
    </block>
    
    <block name="Holding point hover">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <stay wp="_StayHover" until="autopilot_get_mode() == 4"/>
      <deroute block="Holding point hover"/>
    </block>
    
    <block name="Start Engine">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavResurrect()"/>
      <call_once fun="nav_set_heading_current()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
    </block>
    
    <block name="Takeoff 2m" strip_button="Takeoff" strip_icon="takeoff.png">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <stay climb="0.2" alt="2.2" wp="_StayHover"/>
    </block>
    
    <block name="HoverHeigthShip">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <stay alt="WaypointAlt(WP_SHIP)" wp="_StayHover"/>
    </block>
    
    <block name="HoverHeigthApproach">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>    
      <stay alt="WaypointAlt(WP_APPROACH)" wp="_StayHover"/>
    </block>
    
    <block name="route">
      <set value="FALSE" var="force_forward"/>
       <call_once fun="nav_set_heading_towards_waypoint(WP_p2)"/>
      <go from="p1" hmode="route" wp="p2"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_p3)"/>
      <go from="p2" hmode="route" wp="p3"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_p4)"/>
      <go from="p3" hmode="route" wp="p4"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_p1)"/>
      <go from="p4" hmode="route" wp="p1"/>
    </block>
    
    <block name="Standby 5m" strip_button="Standby" strip_icon="home.png">
      <set value="FALSE" var="force_forward"/>
      <stay alt="5.0" wp="STDBY"/>
    </block>
    
    <block name="GoTo Approach point" strip_button="GoTo Approach point">
      <set value="FALSE" var="force_forward"/>
      <stay wp="APPROACH"/>
    </block>
    
    <block name="GoTo Approach point 10m" strip_button="GoTo Approach point 1.5m">
      <set value="FALSE" var="force_forward"/>
      <stay alt="10" wp="APPROACH"/>
    </block>
    
    <block name="GoTo Ship" strip_button="GoTo Ship">
      <set value="FALSE" var="force_forward"/>
      <stay wp="SHIP"/>
    </block>
    
    <block name="Approach SHIP" strip_button="Approach SHIP" strip_icon="boat.png">
      <go wp="APPROACH" />
      <set value="TRUE" var="force_forward"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_SHIP)"/>
      <stay wp="APPROACH" pre_call="approach_moving_target_enable()"/>
    </block>
    
    <block name="Approach SHIP 5m" strip_button="Approach SHIP" strip_icon="boat.png">
      <go wp="APPROACH" />
      <set value="TRUE" var="force_forward"/>
      <call_once fun="approach_moving_target_enable()"/>
      <stay alt="5" wp="APPROACH" pre_call="approach_moving_target_enable()"/>
    </block>
    
    <block name="REPEAT Approach SHIP" strip_button="REPEAT Approach SHIP" strip_icon="boat.png">
      <go wp="APPROACH" />
      <set value="TRUE" var="force_forward"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_SHIP)"/>
      <stay wp="APPROACH" pre_call="approach_moving_target_enable()" until="get_dist2_to_waypoint(WP_SHIP) @LT 0.1"/>
      <set value="FALSE" var="force_forward"/>
      <call_once fun="reset_moving_target_distance()"/>
      <deroute block="REPEAT Approach SHIP"/>
    </block>
    
    <block name="REPEAT Approach SHIP 5m" strip_button="REPEAT Approach SHIP 5m" strip_icon="boat.png">
      <go wp="APPROACH" alt="5.0"/>
      <set value="TRUE" var="force_forward"/>
      <call_once fun="nav_set_heading_towards_waypoint(WP_SHIP)"/>
      <stay alt="5.0" wp="APPROACH" pre_call="approach_moving_target_enable()" until="get_dist2_to_waypoint(WP_SHIP) @LT 0.1"/>
      <set value="FALSE" var="force_forward"/>
      <call_once fun="reset_moving_target_distance()"/>
      <deroute block="REPEAT Approach SHIP"/>
    </block>
    
    <block name="reset_distance_descent">
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <set value="FALSE" var="force_forward"/>
      <call_once fun="reset_moving_target_distance()"/>
      <while cond="LessThan(NavBlockTime(), 2)"/>
      <deroute block="Holding point hover"/>
    </block>
    
    <block name="set_landing_offset_here_TEST">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="target_pos_set_current_offset_here()"/>
      <deroute block="Holding point hover"/>
    </block>
    
    <block name="stay_p1">
      <set value="FALSE" var="force_forward"/>
      <stay wp="p1"/>
    </block>
    
    <block name="stay_HOME_1.5m">
      <set value="FALSE" var="force_forward"/>
      <stay wp="HOME" alt="1.5"/>
    </block>
    
    <block name="go_p2">
      <set value="TRUE" var="force_forward"/>
      <go wp="p2"/>
      <deroute block="stay_p1"/>
    </block>
    
    <block name="line_p1_p2">
      <set value="TRUE" var="force_forward"/>
      <go from="p1" hmode="route" wp="p2"/>
      <stay until="stage_time>10" wp="p2"/>
      <go from="p2" hmode="route" wp="p1"/>
      <deroute block="line_p1_p2"/>
    </block>
    
    <block name="route_p1-p4">
      <set value="TRUE" var="force_forward"/>
      <go wp="p1"/>
      <go from="p1" hmode="route" wp="p2"/>
      <go from="p2" hmode="route" wp="p3"/>
      <go from="p3" hmode="route" wp="p4"/>
      <go from="p4" hmode="route" wp="p1"/>
      <deroute block="stay_p1"/>
    </block>
    
    <block name="Land Here" strip_button="Land Here" strip_icon="land-right.png">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__landHere)"/>
      <stay climb="-0.5" vmode="climb" wp="_landHere"/>
      <exception cond="GetPosHeight() @LT 2.0" deroute="flare"/>
      <deroute block="flare"/>
    </block>
    
    <block name="flare">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavSetWaypointHere3d(WP__landHere)"/>
      <stay climb="-0.2" vmode="climb" wp="_landHere"/>
      <exception cond="GetPosHeight() @LT 0.10" deroute="landed"/>
    </block>
    
    <block name="landed">
      <set value="FALSE" var="force_forward"/>
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="FALSE" vmode="throttle"/>
      <while cond="true"/>
    </block>
    
    <block name="autodescent 53perc throttle TEST">
      <attitude pitch="0" roll="0" throttle="0.53" until="GetPosHeight() @LT 0.2" vmode="throttle"/>
      <call_once fun="NavKillThrottle()"/> <!-- safe crash-->
      <!--deroute block="Holding point kill"/-->
    </block>
    
    <block name="Emergency battery critical">
      <!--stay alt="WaypointAlt(WP_HOME)+2" climb="-0.5" vmode="climb" wp="HOME"/-->
      <stay alt="2.0" climb="-0.5" vmode="climb" wp="HOME"/>
      <deroute block="Emergency battery critical"/>
    </block>
    
    <block name="Emergency connection lost Hover">
      <call_once fun="NavSetWaypointHere3d(WP__StayHover)"/>
      <stay alt="GetPosAlt()" until="!LessThan(NavBlockTime(), 60)" wp="_StayHover"/>
    </block>
    
    <block name="Emergency connection lost Home">
      <stay alt="GetPosAlt()" until="!LessThan(NavBlockTime(), 60)" wp="HOME"/>
    </block>
    
    <block name="Emergency connection lost Descent">
      <stay alt="2" until="!LessThan(NavBlockTime(), 60)" wp="HOME"/>
      <deroute block="flare"/>
    </block>
    
    <block name="Holding point kill">
      <call_once fun="NavKillThrottle()"/>
      <attitude pitch="0" roll="0" throttle="0" until="TRUE" vmode="throttle"/>
      <deroute block="Holding point kill"/>
    </block>
  </blocks>
</flight_plan>
